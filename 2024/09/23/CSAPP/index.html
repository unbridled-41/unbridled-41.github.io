<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>CSAPP | 梦下随笔</title><meta name="author" content="做着百万梦的鱼"><meta name="copyright" content="做着百万梦的鱼"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="对于csapp的学习我的建议是前三章是可以参考九曲阑干的讲解课后习题可以不看（到考试时候突击），但是剩下几章的内容我建议看卡耐基梅隆的公开课（不要看2015年那一版，很难理解），并且课后习题以及作业一定要看要做，不然期末真真的复习不过来。 各章节作业答案及简要解析 Chapter22.5512345678小端机版本	Windows 10 家庭中文版版本号	20H2安装日期	‎2021&#x2F;‎3&#x2F;‎18">
<meta property="og:type" content="article">
<meta property="og:title" content="CSAPP">
<meta property="og:url" content="http://example.com/2024/09/23/CSAPP/index.html">
<meta property="og:site_name" content="梦下随笔">
<meta property="og:description" content="对于csapp的学习我的建议是前三章是可以参考九曲阑干的讲解课后习题可以不看（到考试时候突击），但是剩下几章的内容我建议看卡耐基梅隆的公开课（不要看2015年那一版，很难理解），并且课后习题以及作业一定要看要做，不然期末真真的复习不过来。 各章节作业答案及简要解析 Chapter22.5512345678小端机版本	Windows 10 家庭中文版版本号	20H2安装日期	‎2021&#x2F;‎3&#x2F;‎18">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/picture/person.jpeg">
<meta property="article:published_time" content="2024-09-23T01:08:28.000Z">
<meta property="article:modified_time" content="2024-09-23T05:19:33.355Z">
<meta property="article:author" content="做着百万梦的鱼">
<meta property="article:tag" content="CSAPP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/picture/person.jpeg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2024/09/23/CSAPP/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CSAPP',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-09-23 13:19:33'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body><script>window.paceOptions = {
  restartOnPushState: false
}

document.addEventListener('pjax:send', () => {
  Pace.restart()
})
</script><link rel="stylesheet" href="/./fill-left.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/./picture/person.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">4</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="梦下随笔"><span class="site-name">梦下随笔</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CSAPP</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-09-23T01:08:28.000Z" title="发表于 2024-09-23 09:08:28">2024-09-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-09-23T05:19:33.355Z" title="更新于 2024-09-23 13:19:33">2024-09-23</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>63分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="CSAPP"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>对于csapp的学习我的建议是前三章是可以参考<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1cD4y1D7uR/?spm_id_from=333.337.search-card.all.click&vd_source=7731f99f93f1088243f8d98edf9cd39d">九曲阑干</a>的讲解课后习题可以不看（到考试时候突击），但是剩下几章的内容我建议看<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1dy411B76t/?spm_id_from=333.1007.top_right_bar_window_custom_collection.content.click&vd_source=7731f99f93f1088243f8d98edf9cd39d">卡耐基梅隆的公开课</a>（不要看2015年那一版，很难理解），并且课后习题以及作业一定要看要做，不然期末真真的复习不过来。</p>
<p>各章节作业答案及简要解析</p>
<h1 id="Chapter2"><a href="#Chapter2" class="headerlink" title="Chapter2"></a>Chapter2</h1><h2 id="2-55"><a href="#2-55" class="headerlink" title="2.55"></a>2.55</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">小端机</span><br><span class="line"></span><br><span class="line">版本	Windows 10 家庭中文版</span><br><span class="line">版本号	20H2</span><br><span class="line">安装日期	‎2021/‎3/‎18</span><br><span class="line">操作系统内部版本	19042.1110</span><br><span class="line">序列号	PF1CBRHP</span><br><span class="line">体验	Windows Feature Experience Pack 120.2212.3530.0</span><br></pre></td></tr></table></figure>

<h2 id="2-57"><a href="#2-57" class="headerlink" title="2.57"></a>2.57</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span>* byte_pointer;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">show_bytes</span><span class="params">(byte_pointer start, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">	<span class="type">size_t</span> i;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot; %.2x&quot;</span>, start[i]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">show_short</span><span class="params">(<span class="type">short</span> x)</span> &#123;</span><br><span class="line">	show_bytes((byte_pointer)&amp;x, <span class="keyword">sizeof</span>(<span class="type">short</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">show_int</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">	show_bytes((byte_pointer)&amp;x, <span class="keyword">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">show_float</span><span class="params">(<span class="type">float</span> x)</span> &#123;</span><br><span class="line">	show_bytes((byte_pointer)&amp;x, <span class="keyword">sizeof</span>(<span class="type">float</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">show_long</span><span class="params">(<span class="type">long</span> x)</span> &#123;</span><br><span class="line">	show_bytes((byte_pointer)&amp;x, <span class="keyword">sizeof</span>(<span class="type">long</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">show_double</span><span class="params">(<span class="type">double</span> x)</span> &#123;</span><br><span class="line">	show_bytes((byte_pointer)&amp;x, <span class="keyword">sizeof</span>(<span class="type">double</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-58"><a href="#2-58" class="headerlink" title="2.58"></a>2.58</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">is_little_endian</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">short</span> s = <span class="number">1</span>;</span><br><span class="line">	byte_pointer p = (byte_pointer)&amp;s;</span><br><span class="line">	<span class="keyword">return</span> *p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-59"><a href="#2-59" class="headerlink" title="2.59"></a>2.59</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">Problem_2_59_</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> (x &amp; <span class="number">0xFF</span>) | (y &amp; (~<span class="number">0xFF</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-60"><a href="#2-60" class="headerlink" title="2.60"></a>2.60</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="title function_">replace_byte</span><span class="params">(<span class="type">unsigned</span> x, <span class="type">int</span> i, <span class="type">unsigned</span> <span class="type">char</span> b)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> mask = <span class="number">0xFF</span> &lt;&lt; (i * <span class="number">8</span>);</span><br><span class="line">	x = x &amp; (~mask);</span><br><span class="line">	<span class="keyword">return</span> x | (b &lt;&lt; (i * <span class="number">8</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-61"><a href="#2-61" class="headerlink" title="2.61"></a>2.61</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">Problem_2_61_</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">	<span class="type">int</span> w = <span class="keyword">sizeof</span>(<span class="type">int</span>) &lt;&lt; <span class="number">3</span>;</span><br><span class="line">	<span class="keyword">return</span> (x == <span class="number">-1</span>) || (x == <span class="number">0</span>) || ((x &amp; <span class="number">0xFF</span>) == <span class="number">0xFF</span>) || (!((x &gt;&gt; (w - <span class="number">8</span>)) &amp; <span class="number">0xFF</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-62"><a href="#2-62" class="headerlink" title="2.62"></a>2.62</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">int_shifts_are_arithmetic</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">int</span> x = <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">return</span> (x &gt;&gt; <span class="number">1</span>) == x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-63"><a href="#2-63" class="headerlink" title="2.63"></a>2.63</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="title function_">srl</span><span class="params">(<span class="type">unsigned</span> x, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">	<span class="comment">/* Perform shift arithmetically */</span></span><br><span class="line">	<span class="type">unsigned</span> xsra = (<span class="type">int</span>)x &gt;&gt; k;</span><br><span class="line">	<span class="type">int</span> w = <span class="keyword">sizeof</span>(<span class="type">int</span>) &lt;&lt; <span class="number">3</span>;</span><br><span class="line">	<span class="type">int</span> mask = (<span class="number">1</span> &lt;&lt; (w - k)) - <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">return</span> mask &amp; xsra;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sra</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">	<span class="comment">/* Perform shift logically */</span></span><br><span class="line">	<span class="type">int</span> xsrl = (<span class="type">unsigned</span>)x &gt;&gt; k;</span><br><span class="line">	<span class="type">int</span> w = <span class="keyword">sizeof</span>(<span class="type">int</span>) &lt;&lt; <span class="number">3</span>;</span><br><span class="line">	<span class="type">int</span> z = <span class="number">1</span> &lt;&lt; (w - k - <span class="number">1</span>);</span><br><span class="line">	<span class="type">int</span> mask = z - <span class="number">1</span>;</span><br><span class="line">	<span class="type">int</span> right = mask &amp; xsrl;</span><br><span class="line">	<span class="type">int</span> left = (~mask) &amp; ((~(z &amp; xsrl)) + z);</span><br><span class="line">	<span class="keyword">return</span> right | left;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-64"><a href="#2-64" class="headerlink" title="2.64"></a>2.64</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Return 1 when any odd bit of x euqals 1; 0 otherwise.</span></span><br><span class="line"><span class="comment"> * Assume w = 32</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">any_odd_one</span><span class="params">(<span class="type">unsigned</span> x)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> !!(x &amp; <span class="number">0xAAAAAAAA</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-65"><a href="#2-65" class="headerlink" title="2.65"></a>2.65</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Return 1 when x contains an odd number of 1s; 0 otherwise.</span></span><br><span class="line"><span class="comment"> * Assume w = 32</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">odd_ones</span><span class="params">(<span class="type">unsigned</span> x)</span> &#123;</span><br><span class="line">	x = (x &gt;&gt; <span class="number">16</span>) ^ x;</span><br><span class="line">	x = (x &gt;&gt; <span class="number">8</span>) ^ x;</span><br><span class="line">	x = (x &gt;&gt; <span class="number">4</span>) ^ x;</span><br><span class="line">	x = (x &gt;&gt; <span class="number">2</span>) ^ x;</span><br><span class="line">	x = (x &gt;&gt; <span class="number">1</span>) ^ x;</span><br><span class="line">	<span class="keyword">return</span> x &amp; <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-66"><a href="#2-66" class="headerlink" title="2.66"></a>2.66</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Generate mask indicating leftmost 1 in x.  Assume w = 32</span></span><br><span class="line"><span class="comment"> * For example, 0xFF00 --&gt; 0x8000, and 0x6600 --&gt; 0x4000</span></span><br><span class="line"><span class="comment"> * If x = 0, then return 0.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">leftmost_ones</span><span class="params">(<span class="type">unsigned</span> x)</span> &#123;</span><br><span class="line">	x |= (x &gt;&gt; <span class="number">1</span>);</span><br><span class="line">	x |= (x &gt;&gt; <span class="number">2</span>);</span><br><span class="line">	x |= (x &gt;&gt; <span class="number">4</span>);</span><br><span class="line">	x |= (x &gt;&gt; <span class="number">8</span>);</span><br><span class="line">	x |= (x &gt;&gt; <span class="number">16</span>);</span><br><span class="line">	<span class="keyword">return</span> x ^ (x &gt;&gt; <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-67"><a href="#2-67" class="headerlink" title="2.67"></a>2.67</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">A. 移位应小于<span class="number">32</span>位</span><br><span class="line"><span class="comment">/* Work successfully on 32-bit machine */</span></span><br><span class="line"><span class="type">int</span>  <span class="title function_">int_size_is_32_B</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">int</span> x = <span class="number">1</span> &lt;&lt; <span class="number">31</span>;</span><br><span class="line">	<span class="keyword">return</span> !(x &lt;&lt; <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Work successfully on 16-bit machine */</span></span><br><span class="line"><span class="type">int</span>  <span class="title function_">int_size_is_32_C</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">int</span> x = <span class="number">1</span> &lt;&lt; <span class="number">15</span>;</span><br><span class="line">	<span class="type">int</span> y = x &lt;&lt; <span class="number">15</span>;</span><br><span class="line">	<span class="keyword">return</span> (x &lt;&lt; <span class="number">1</span>) &amp;&amp; !(y &lt;&lt; <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-68"><a href="#2-68" class="headerlink" title="2.68"></a>2.68</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * Mask with least signficant n bits set to 1</span></span><br><span class="line"><span class="comment"> * Examples: n = 6 --&gt; 0x3F, n == 17 --&gt; 0x1FFFF</span></span><br><span class="line"><span class="comment"> * Assume 1 &lt;= n &lt;= w</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">lower_one_mask</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> (<span class="number">2</span> &lt;&lt; (n - <span class="number">1</span>)) - <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-69"><a href="#2-69" class="headerlink" title="2.69"></a>2.69</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Do ratating left shift.  Assume 0 &lt;= n &lt; w</span></span><br><span class="line"><span class="comment"> * Examples when x = 0x12345678 and w = 32</span></span><br><span class="line"><span class="comment"> *	n = 4 -&gt; 0x23456781, n = 20 -&gt; 0x67812345</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="title function_">rotate_left</span><span class="params">(<span class="type">unsigned</span> x, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">	<span class="comment">/* Special treatment for the case of n = 0 */</span></span><br><span class="line">	<span class="type">unsigned</span> w = <span class="keyword">sizeof</span>(<span class="type">unsigned</span>) &lt;&lt; <span class="number">3</span>;</span><br><span class="line">	<span class="type">unsigned</span> not_shift_out = ((<span class="number">1</span> &lt;&lt; (w - n + <span class="number">1</span>)) - <span class="number">1</span>) &amp; x;</span><br><span class="line">	<span class="type">unsigned</span> shift_out = ((((INT_MIN) &gt;&gt; n) &lt;&lt; <span class="number">1</span>) &amp; x) &gt;&gt; (w - n);</span><br><span class="line">	<span class="type">unsigned</span> rotated = (not_shift_out &lt;&lt; n) | shift_out;</span><br><span class="line">	<span class="comment">/* If n != 0, rotated is the right answer, otherwise rotated is 0 */</span></span><br><span class="line">	n = (n &lt;&lt; <span class="number">16</span>) | n;</span><br><span class="line">	n = (n &lt;&lt; <span class="number">8</span>) | n;</span><br><span class="line">	n = (n &lt;&lt; <span class="number">4</span>) | n;</span><br><span class="line">	n = (n &lt;&lt; <span class="number">2</span>) | n;</span><br><span class="line">	n = (n &lt;&lt; <span class="number">1</span>) | n;</span><br><span class="line">	n = n &gt;&gt; <span class="number">31</span>;</span><br><span class="line">	<span class="comment">/* n ? rotated : x */</span></span><br><span class="line">	<span class="keyword">return</span> (n &amp; rotated) + ((~n) &amp; x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-70"><a href="#2-70" class="headerlink" title="2.70"></a>2.70</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Return 1 when x can be represented as an n-bit, 2&#x27;s-complement</span></span><br><span class="line"><span class="comment"> * number; 0 otherwise</span></span><br><span class="line"><span class="comment"> * Assume 1 &lt;= n &lt;= w</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fits_bits</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If x is a positive number,</span></span><br><span class="line"><span class="comment">	 * ensure that x is shifted to 0 and </span></span><br><span class="line"><span class="comment">	 * the highest bit of the new n-bit number is 0 </span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * * If x is a negative number,</span></span><br><span class="line"><span class="comment">	 * ensure that x is shifted to -1 and </span></span><br><span class="line"><span class="comment">	 * the highest bit of the new n-bit number is 1 </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">int</span> test_bit = (<span class="number">1</span> &lt;&lt; (n - <span class="number">1</span>)) &amp; x;</span><br><span class="line">	x &gt;&gt;= n;</span><br><span class="line">	<span class="keyword">return</span> (!x &amp;&amp; !test_bit) || (!(x + <span class="number">1</span>) &amp;&amp; test_bit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-71"><a href="#2-71" class="headerlink" title="2.71"></a>2.71</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">A. 未实现符号拓展，高位总为<span class="number">0</span></span><br><span class="line"><span class="comment">/* Declaration of data type where 4 bytes are picked</span></span><br><span class="line"><span class="comment"> * into an unsigned</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">packed_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Extract byte from word.  Return as signed integer */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">xbyte</span><span class="params">(<span class="type">packed_t</span> word, <span class="type">int</span> bytenum)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> ((<span class="type">int</span>)(word &lt;&lt; ((<span class="number">3</span> - bytenum) &lt;&lt; <span class="number">3</span>))) &gt;&gt; <span class="number">24</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2-72"><a href="#2-72" class="headerlink" title="2.72"></a>2.72</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">A. 表达式隐式转换为无符号数结果，故总大于等于<span class="number">0</span></span><br><span class="line"><span class="comment">/* Copy integer into buffer if space is avaiable */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">copy_int</span><span class="params">(<span class="type">int</span> val, <span class="type">void</span>* buf, <span class="type">int</span> maxbytes)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (maxbytes &gt; <span class="number">0</span> &amp;&amp; (maxbytes &gt;= <span class="keyword">sizeof</span>(val)))</span><br><span class="line">		<span class="built_in">memcpy</span>(buf, (<span class="type">void</span>*)&amp;val, <span class="keyword">sizeof</span>(val));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-73"><a href="#2-73" class="headerlink" title="2.73"></a>2.73</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Addtion that saturates to TMin or Tmax */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">saturating_add</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">	<span class="type">int</span> w = <span class="keyword">sizeof</span>(<span class="type">int</span>) &lt;&lt; <span class="number">3</span>;</span><br><span class="line">	<span class="type">int</span> z = x + y;</span><br><span class="line">	<span class="type">int</span> _sign_x_ = x &gt;&gt; (w - <span class="number">1</span>);</span><br><span class="line">	<span class="type">int</span> _sign_y_ = y &gt;&gt; (w - <span class="number">1</span>);</span><br><span class="line">	<span class="type">int</span> _sign_z_ = z &gt;&gt; (w - <span class="number">1</span>);</span><br><span class="line">	<span class="type">int</span> _sign_xor_ = (x ^ y) &gt;&gt; (w - <span class="number">1</span>);</span><br><span class="line">	<span class="comment">/* </span></span><br><span class="line"><span class="comment">	 * If x,y with different signs, addition does not overflow,</span></span><br><span class="line"><span class="comment">	 * ans = x + y. Otherwise ans is zero.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">int</span> _ans_both_positive_ = (~_sign_x_) &amp; (~_sign_y_) &amp; _sign_z_ &amp; INT_MAX;</span><br><span class="line">	<span class="type">int</span> _ans_both_negative_ = _sign_x_ &amp; _sign_y_ &amp; (~_sign_z_) &amp; (INT_MIN);</span><br><span class="line">	<span class="type">int</span> _ans_xor_ = _sign_xor_ &amp; (x + y);</span><br><span class="line">	<span class="keyword">return</span> _ans_both_positive_ + _ans_both_negative_ + _ans_xor_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-74"><a href="#2-74" class="headerlink" title="2.74"></a>2.74</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Determine whether arguments can be substracted without overflow */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">tsub_ok</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">	<span class="type">int</span> w = <span class="keyword">sizeof</span>(<span class="type">int</span>) &lt;&lt; <span class="number">3</span>;</span><br><span class="line">	<span class="type">int</span> z = x - y;</span><br><span class="line">	<span class="type">int</span> _sign_x_ = x &gt;&gt; (w - <span class="number">1</span>);</span><br><span class="line">	<span class="type">int</span> _sign_y_ = y &gt;&gt; (w - <span class="number">1</span>);</span><br><span class="line">	<span class="type">int</span> _sign_z_ = z &gt;&gt; (w - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * if x &gt;= 0, y &gt;= 0, x - y never overflow</span></span><br><span class="line"><span class="comment">	 * if x &gt;= 0, y &lt;  0, x - y may overflow, when overflow, _sign_z_ is all 1s</span></span><br><span class="line"><span class="comment">	 * if x &lt;  0, y &gt;= 0, x - y may overflow, when overflow, _sign_z_ is 0</span></span><br><span class="line"><span class="comment">	 * if x &lt;  0, y &lt;  0, x - y never overflow</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">int</span> _ans_xpyn_overflow_ = (~_sign_x_) &amp; _sign_y_ &amp; _sign_z_;</span><br><span class="line">	<span class="type">int</span> _ans_xnyp_overflow_ = _sign_x_ &amp; (~_sign_y_) &amp; (~_sign_z_);</span><br><span class="line">	<span class="keyword">return</span> !(_ans_xpyn_overflow_ || _ans_xnyp_overflow_);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-75"><a href="#2-75" class="headerlink" title="2.75"></a>2.75</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">signed_high_prod</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">	<span class="type">int</span> w = <span class="keyword">sizeof</span>(<span class="type">int</span>) &lt;&lt; <span class="number">3</span>;</span><br><span class="line">	<span class="type">long</span> tmp_x = (<span class="type">long</span>)x;</span><br><span class="line">	<span class="type">long</span> tmp_y = (<span class="type">long</span>)y;</span><br><span class="line">	<span class="keyword">return</span> (<span class="type">int</span>)((tmp_x * tmp_y) &gt;&gt; w);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">unsigned</span> <span class="title function_">unsigned_high_prod</span><span class="params">(<span class="type">unsigned</span> x, <span class="type">unsigned</span> y)</span> &#123;</span><br><span class="line">	<span class="type">int</span> w = <span class="keyword">sizeof</span>(<span class="type">int</span>) &lt;&lt; <span class="number">3</span>;</span><br><span class="line">	<span class="type">unsigned</span> x_sign = ((<span class="type">int</span>)x) &gt;&gt; (w - <span class="number">1</span>);</span><br><span class="line">	<span class="type">unsigned</span> y_sign = ((<span class="type">int</span>)y) &gt;&gt; (w - <span class="number">1</span>);</span><br><span class="line">	<span class="type">unsigned</span> ans = signed_high_prod(x, y) + (x_sign &amp; y) + (y_sign &amp; x);</span><br><span class="line">	<span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-76"><a href="#2-76" class="headerlink" title="2.76"></a>2.76</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span>* <span class="title function_">Calloc</span><span class="params">(<span class="type">size_t</span> nmemb, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (nmemb == <span class="number">0</span> || size == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="type">size_t</span> total = nmemb * size;</span><br><span class="line">	<span class="keyword">if</span> (total / nmemb == size) &#123;</span><br><span class="line">		<span class="type">void</span>* p = <span class="built_in">malloc</span>(total);</span><br><span class="line">		<span class="built_in">memset</span>(p, <span class="number">0</span>, nmemb);</span><br><span class="line">		<span class="keyword">return</span> p;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-77"><a href="#2-77" class="headerlink" title="2.77"></a>2.77</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">Problem_2_77_A</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> (x &lt;&lt; <span class="number">4</span>) + x;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">Problem_2_77_B</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> -(x &lt;&lt; <span class="number">3</span>) + x;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">Problem_2_77_C</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> (x &lt;&lt; <span class="number">6</span>) - (x &lt;&lt; <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">Problem_2_77_D</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> -(x &lt;&lt; <span class="number">7</span>) + (x &lt;&lt; <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-78"><a href="#2-78" class="headerlink" title="2.78"></a>2.78</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Divide by power of 2. Assume 0 &lt;= k &lt; w - 1 */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">divide_power2</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">	<span class="type">int</span> sign = x &gt;&gt; <span class="number">31</span>;</span><br><span class="line">	<span class="type">int</span> x_is_non_negative = x &gt;&gt; k;</span><br><span class="line">	<span class="type">int</span> x_is_negative = (x + ((<span class="number">1</span> &lt;&lt; k) - <span class="number">1</span>)) &gt;&gt; k;</span><br><span class="line">	<span class="keyword">return</span> ((~sign) &amp; x_is_non_negative) + (sign &amp; x_is_negative);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-79"><a href="#2-79" class="headerlink" title="2.79"></a>2.79</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">mul3div4</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> ((x &lt;&lt; <span class="number">1</span>) + x) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-80"><a href="#2-80" class="headerlink" title="2.80"></a>2.80</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">threefourths</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * calculate 3/4x, no overflow, round to zero</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * no overflow means divide 4 first, then multiple 3, diffrent from 2.79 here</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * rounding to zero is a little complicated.</span></span><br><span class="line"><span class="comment">	 * every int x, equals f(first 30 bit number) plus l(last 2 bit number)</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 *   f = x &amp; ~0x3</span></span><br><span class="line"><span class="comment">	 *   l = x &amp; 0x3</span></span><br><span class="line"><span class="comment">	 *   x = f + l</span></span><br><span class="line"><span class="comment">	 *   threeforths(x) = f/4*3 + l*3/4</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * f doesn&#x27;t care about round at all, we just care about rounding from l*3/4</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 *   lm3 = (l &lt;&lt; 1) + l</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * when x &gt; 0, rounding to zero is easy</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 *   lm3d4 = lm3 &gt;&gt; 2</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * when x &lt; 0, rounding to zero acts like divide_power2 in 2.78</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 *   bias = 0x3    // (1 &lt;&lt; 2) - 1</span></span><br><span class="line"><span class="comment">	 *   lm3d4 = (lm3 + bias) &gt;&gt; 2</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">int</span> is_negative = x &amp; INT_MIN;</span><br><span class="line">	<span class="comment">/* Split x into high 30 digits and low two digits */</span></span><br><span class="line">	<span class="type">int</span> f = x &amp; (~<span class="number">0b11</span>);</span><br><span class="line">	<span class="type">int</span> l = x &amp; (<span class="number">0b11</span>);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> fd4 = f &gt;&gt; <span class="number">2</span>;</span><br><span class="line">	<span class="type">int</span> fd4m3 = (fd4 &lt;&lt; <span class="number">1</span>) + fd4;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> lm3 = (l &lt;&lt; <span class="number">1</span>) + l;</span><br><span class="line">	<span class="type">int</span> bias = (<span class="number">1</span> &lt;&lt; <span class="number">2</span>) - <span class="number">1</span>;</span><br><span class="line">	(is_negative &amp;&amp; (lm3 += bias));</span><br><span class="line">	<span class="type">int</span> lm3d4 = lm3 &gt;&gt; <span class="number">2</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> fd4m3 + lm3d4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-81"><a href="#2-81" class="headerlink" title="2.81"></a>2.81</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">Problem_2_81_A</span><span class="params">(<span class="type">int</span> k)</span> &#123;</span><br><span class="line">	<span class="type">int</span> odd = k &amp; <span class="number">1</span>;</span><br><span class="line">	<span class="type">int</span> ans = <span class="number">-1</span> &lt;&lt; (k &gt;&gt; <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">return</span> ans &lt;&lt; ((k &gt;&gt; <span class="number">1</span>) + odd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">Problem_2_81_B</span><span class="params">(<span class="type">int</span> j, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">	<span class="type">int</span> w = <span class="keyword">sizeof</span>(<span class="type">int</span>) &lt;&lt; <span class="number">3</span>;</span><br><span class="line">	<span class="type">int</span> <span class="built_in">exp</span> = w - k;</span><br><span class="line">	<span class="type">int</span> odd_left_part = <span class="built_in">exp</span> &amp; <span class="number">1</span>;</span><br><span class="line">	<span class="type">int</span> odd_right_part = j &amp; <span class="number">1</span>;</span><br><span class="line">	<span class="type">unsigned</span> ans = ~<span class="number">0</span>;</span><br><span class="line">	ans = (ans &gt;&gt; (<span class="built_in">exp</span> &gt;&gt; <span class="number">1</span>)) &gt;&gt; ((<span class="built_in">exp</span> &gt;&gt; <span class="number">1</span>) + odd_left_part);</span><br><span class="line">	<span class="keyword">return</span> (ans &lt;&lt; (j &gt;&gt; <span class="number">1</span>)) &lt;&lt; ((j &gt;&gt; <span class="number">1</span>) + odd_right_part);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-82"><a href="#2-82" class="headerlink" title="2.82"></a>2.82</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* Problem_2_82</span><br><span class="line">* A. False (x = TMin, y = <span class="number">0</span>)</span><br><span class="line">* B. True</span><br><span class="line">* C. True</span><br><span class="line">* D. True</span><br><span class="line">* E. True</span><br></pre></td></tr></table></figure>

<h2 id="2-83"><a href="#2-83" class="headerlink" title="2.83"></a>2.83</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* Problem_2_83</span><br><span class="line">* Let x be the value of the infinite sequence,</span><br><span class="line">* then x * (<span class="number">2</span> ^ k) = Y + x.</span><br><span class="line">* So x = Y / ((<span class="number">2</span> ^ k) - <span class="number">1</span>)</span><br><span class="line">* </span><br><span class="line">* B(a):<span class="number">5</span>/<span class="number">7</span></span><br><span class="line">* B(b):<span class="number">6</span>/<span class="number">15</span></span><br><span class="line">* B(c):<span class="number">19</span>/<span class="number">63</span></span><br></pre></td></tr></table></figure>

<h2 id="2-84"><a href="#2-84" class="headerlink" title="2.84"></a>2.84</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="title function_">f2u</span><span class="params">(<span class="type">float</span> f)</span> &#123;</span><br><span class="line">	byte_pointer bp = (byte_pointer)&amp;f;</span><br><span class="line">	<span class="keyword">return</span> (<span class="type">unsigned</span>)(bp[<span class="number">0</span>] + (bp[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>) + (bp[<span class="number">2</span>] &lt;&lt; <span class="number">16</span>) + (bp[<span class="number">3</span>] &lt;&lt; <span class="number">24</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">float_le</span><span class="params">(<span class="type">float</span> x, <span class="type">float</span> y)</span> &#123;</span><br><span class="line">	<span class="type">unsigned</span> ux = f2u(x);</span><br><span class="line">	<span class="type">unsigned</span> uy = f2u(y);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Get the sign bits */</span></span><br><span class="line">	<span class="type">unsigned</span> sx = ux &gt;&gt; <span class="number">31</span>;</span><br><span class="line">	<span class="type">unsigned</span> sy = uy &gt;&gt; <span class="number">31</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Give an expression using only ux, uy, sx and sy */</span></span><br><span class="line">	<span class="keyword">return</span> (sx &amp;&amp; !sy) || (sx &amp;&amp; sy &amp;&amp; (ux &gt;= uy)) || (!sx &amp;&amp; !sy &amp;&amp; (ux &lt;= uy));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-85"><a href="#2-85" class="headerlink" title="2.85"></a>2.85</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* Problem_2_85</span><br><span class="line">* bias = (<span class="number">2</span> ^ (k - <span class="number">1</span>)) - <span class="number">1</span>;</span><br><span class="line">* </span><br><span class="line">* A. <span class="number">7.0</span> = ((bias + <span class="number">2</span>) &lt;&lt; n) | (<span class="number">0b11</span> &lt;&lt; (n - <span class="number">2</span>))</span><br><span class="line">* B. Greatest odd integer = ((bias + n) &lt;&lt; n) | ((<span class="number">1</span> &lt;&lt; n) - <span class="number">1</span>)</span><br><span class="line">* C. reciprocal of the minimum normalized number = ((<span class="number">2</span> ^ k) - <span class="number">3</span>) &lt;&lt; n</span><br></pre></td></tr></table></figure>

<h2 id="2-90"><a href="#2-90" class="headerlink" title="2.90"></a>2.90</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> <span class="title function_">u2f</span><span class="params">(<span class="type">unsigned</span> u)</span> &#123;</span><br><span class="line">	<span class="type">float</span> f;</span><br><span class="line">	byte_pointer up = (byte_pointer)&amp;u;</span><br><span class="line">	byte_pointer fp = (byte_pointer)&amp;f;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>;i &lt; <span class="keyword">sizeof</span>(<span class="type">unsigned</span>);i++) &#123;</span><br><span class="line">		fp[i] = up[i];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> f;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">float</span> <span class="title function_">fpwr2</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">	<span class="comment">/* Result exponent and fraction */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="built_in">exp</span>, frac;</span><br><span class="line">	<span class="type">unsigned</span> u;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (x &lt; <span class="number">-149</span>) &#123;</span><br><span class="line">		<span class="comment">/* Too small.  Return 0.0 */</span></span><br><span class="line">		<span class="built_in">exp</span> = <span class="number">0</span>;</span><br><span class="line">		frac = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (x &lt; <span class="number">-126</span>) &#123;</span><br><span class="line">		<span class="comment">/* Denormalized result */</span></span><br><span class="line">		<span class="built_in">exp</span> = <span class="number">0</span>;</span><br><span class="line">		frac = <span class="number">1</span> &lt;&lt; (<span class="number">149</span> + x);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (x &lt; <span class="number">128</span>) &#123;</span><br><span class="line">		<span class="comment">/* Normalized result */</span></span><br><span class="line">		<span class="built_in">exp</span> = x + <span class="number">127</span>;</span><br><span class="line">		frac = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/* Too big.  Return Infinity*/</span></span><br><span class="line">		<span class="built_in">exp</span> = <span class="number">0xFF</span>;</span><br><span class="line">		frac = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Pack exp and frac into 32 bits */</span></span><br><span class="line">	u = <span class="built_in">exp</span> &lt;&lt; <span class="number">23</span> | frac;</span><br><span class="line">	<span class="comment">/* Return as float */</span></span><br><span class="line">	<span class="keyword">return</span> u2f(u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-92"><a href="#2-92" class="headerlink" title="2.92"></a>2.92</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Compute -f.  If f is NaN, then return f. */</span></span><br><span class="line">float_bits <span class="title function_">float_negate</span><span class="params">(float_bits f)</span> &#123;</span><br><span class="line">	<span class="comment">/* Decompose bit representation into parts */</span></span><br><span class="line">	<span class="type">unsigned</span> sign = f &gt;&gt; <span class="number">31</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="built_in">exp</span> = (f &gt;&gt; <span class="number">23</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">	<span class="type">unsigned</span> frac = f &amp; <span class="number">0x7FFFFF</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">exp</span> == <span class="number">0xFF</span> &amp;&amp; frac) <span class="keyword">return</span> f;</span><br><span class="line">	<span class="keyword">return</span> ((~sign) &lt;&lt; <span class="number">31</span>) | (<span class="built_in">exp</span> &lt;&lt; <span class="number">23</span>) | frac;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-93"><a href="#2-93" class="headerlink" title="2.93"></a>2.93</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Compute |f|.  If f is NaN, then return f. */</span></span><br><span class="line">float_bits <span class="title function_">float_absval</span><span class="params">(float_bits f)</span> &#123;</span><br><span class="line">	<span class="comment">/* Decompose bit representation into parts */</span></span><br><span class="line">	<span class="type">unsigned</span> sign = f &gt;&gt; <span class="number">31</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="built_in">exp</span> = (f &gt;&gt; <span class="number">23</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">	<span class="type">unsigned</span> frac = f &amp; <span class="number">0x7FFFFF</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">exp</span> == <span class="number">0xFF</span> &amp;&amp; frac) <span class="keyword">return</span> f;</span><br><span class="line">	<span class="keyword">return</span> (<span class="built_in">exp</span> &lt;&lt; <span class="number">23</span>) | frac;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-94"><a href="#2-94" class="headerlink" title="2.94"></a>2.94</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Compute 2*f.  If f is NaN, then return f. */</span></span><br><span class="line">float_bits <span class="title function_">float_twice</span><span class="params">(float_bits f)</span> &#123;</span><br><span class="line">	<span class="comment">/* Decompose bit representation into parts */</span></span><br><span class="line">	<span class="type">unsigned</span> sign = f &gt;&gt; <span class="number">31</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="built_in">exp</span> = (f &gt;&gt; <span class="number">23</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">	<span class="type">unsigned</span> frac = f &amp; <span class="number">0x7FFFFF</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">exp</span> == <span class="number">0xFF</span>) <span class="keyword">return</span> f;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">exp</span> == <span class="number">0</span>) <span class="keyword">return</span> (sign &lt;&lt; <span class="number">31</span>) | (frac &lt;&lt; <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">exp</span> == <span class="number">0xFE</span>) <span class="keyword">return</span> (sign &lt;&lt; <span class="number">31</span>) | (<span class="number">0xFF</span> &lt;&lt; <span class="number">23</span>);</span><br><span class="line">	<span class="keyword">return</span> (sign &lt;&lt; <span class="number">31</span>) | ((<span class="built_in">exp</span> + <span class="number">1</span>) &lt;&lt; <span class="number">23</span>) | frac;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-95"><a href="#2-95" class="headerlink" title="2.95"></a>2.95</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Compute 0.5*f.  If f is NaN, then return f. */</span></span><br><span class="line">float_bits <span class="title function_">float_half</span><span class="params">(float_bits f)</span> &#123;</span><br><span class="line">	<span class="comment">/* Decompose bit representation into parts */</span></span><br><span class="line">	<span class="type">unsigned</span> sign = f &gt;&gt; <span class="number">31</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="built_in">exp</span> = (f &gt;&gt; <span class="number">23</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">	<span class="type">unsigned</span> frac = f &amp; <span class="number">0x7FFFFF</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">exp</span> == <span class="number">0xFF</span>) <span class="keyword">return</span> f;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">exp</span> == <span class="number">0</span>) <span class="keyword">return</span> (sign &lt;&lt; <span class="number">31</span>) | (frac &gt;&gt; <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">exp</span> == <span class="number">1</span>) <span class="keyword">return</span> (sign &lt;&lt; <span class="number">31</span>) | (frac &gt;&gt; <span class="number">1</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">22</span>);</span><br><span class="line">	<span class="keyword">return</span> (sign &lt;&lt; <span class="number">31</span>) | ((<span class="built_in">exp</span> - <span class="number">1</span>) &lt;&lt; <span class="number">23</span>) | frac;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-96"><a href="#2-96" class="headerlink" title="2.96"></a>2.96</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Compute (int) f.</span></span><br><span class="line"><span class="comment"> * If conversion causes overflow of f is NaN, return 0x80000000</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">float_f2i</span><span class="params">(float_bits f)</span> &#123;</span><br><span class="line">	<span class="comment">/* Decompose bit representation into parts */</span></span><br><span class="line">	<span class="type">unsigned</span> sign = f &gt;&gt; <span class="number">31</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="built_in">exp</span> = (f &gt;&gt; <span class="number">23</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">	<span class="type">unsigned</span> frac = f &amp; <span class="number">0x7FFFFF</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> bias = (<span class="number">1</span> &lt;&lt; <span class="number">7</span>) - <span class="number">1</span>;</span><br><span class="line">	<span class="type">unsigned</span> absval = <span class="number">0x80000000</span>;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">exp</span> &gt; bias + <span class="number">30</span>) &#123;</span><br><span class="line">		<span class="comment">/* Too big.  Return 0x80000000 */</span></span><br><span class="line">		<span class="keyword">return</span> absval;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">exp</span> &gt;= bias + <span class="number">23</span>) &#123;</span><br><span class="line">		absval = ((<span class="number">1</span> &lt;&lt; <span class="number">23</span>) | frac) &lt;&lt; (<span class="built_in">exp</span> - bias - <span class="number">23</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">exp</span> &gt;= bias) &#123;</span><br><span class="line">		absval = ((<span class="number">1</span> &lt;&lt; <span class="number">23</span>) | frac) &gt;&gt; (bias + <span class="number">23</span> - <span class="built_in">exp</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/* f &lt; 1 */</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	sign &amp;&amp; (absval = (~absval) + <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">return</span> absval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-97"><a href="#2-97" class="headerlink" title="2.97"></a>2.97</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Compute (float) i */</span></span><br><span class="line">float_bits <span class="title function_">float_i2f</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">	<span class="type">unsigned</span> sign = (i &gt;&gt; <span class="number">31</span>) &amp; <span class="number">1</span>;</span><br><span class="line">	<span class="type">unsigned</span> bias = (<span class="number">1</span> &lt;&lt; <span class="number">7</span>) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> absval = i;</span><br><span class="line">	sign &amp;&amp; (absval = (~absval) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> power = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> tmpval = absval;</span><br><span class="line">	(tmpval &gt;&gt; <span class="number">16</span>) &amp;&amp; (power += <span class="number">16</span>) &amp;&amp; (tmpval &gt;&gt;= <span class="number">16</span>);</span><br><span class="line">	(tmpval &gt;&gt; <span class="number">8</span>) &amp;&amp; (power += <span class="number">8</span>) &amp;&amp; (tmpval &gt;&gt;= <span class="number">8</span>);</span><br><span class="line">	(tmpval &gt;&gt; <span class="number">4</span>) &amp;&amp; (power += <span class="number">4</span>) &amp;&amp; (tmpval &gt;&gt;= <span class="number">4</span>);</span><br><span class="line">	(tmpval &gt;&gt; <span class="number">2</span>) &amp;&amp; (power += <span class="number">2</span>) &amp;&amp; (tmpval &gt;&gt;= <span class="number">2</span>);</span><br><span class="line">	(tmpval &gt;&gt; <span class="number">1</span>) &amp;&amp; (power += <span class="number">1</span>) &amp;&amp; (tmpval &gt;&gt;= <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> E = power + bias;</span><br><span class="line">	<span class="type">unsigned</span> frac = absval - (<span class="number">1</span> &lt;&lt; power);</span><br><span class="line">	<span class="keyword">if</span> (power &gt;= <span class="number">23</span>) &#123;</span><br><span class="line">		frac &gt;&gt;= power - <span class="number">23</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> frac &gt;&gt;= <span class="number">22</span> - power;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> (sign &lt;&lt; <span class="number">31</span>) | (E &lt;&lt; <span class="number">23</span>) | frac;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Chapter3"><a href="#Chapter3" class="headerlink" title="Chapter3"></a>Chapter3</h1><h2 id="3-58"><a href="#3-58" class="headerlink" title="3.58"></a>3.58</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">decode2</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y, <span class="type">long</span> z)</span> &#123;</span><br><span class="line">	y = y - z;</span><br><span class="line">	x = x * y;</span><br><span class="line">	<span class="keyword">return</span> (y &amp; <span class="number">1</span>) ? ~x : x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-59"><a href="#3-59" class="headerlink" title="3.59"></a>3.59</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> __int128 <span class="type">int128_t</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">store_prod</span><span class="params">(<span class="type">int128_t</span> *dest, <span class="type">int64_t</span> x, <span class="type">int64_t</span> y)</span> &#123;</span><br><span class="line">	*dest = x * (<span class="type">int128_t</span>) y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	X = Xhigh * <span class="number">2</span>^<span class="number">64</span> + Xlow</span><br><span class="line">	Y = Yhigh * <span class="number">2</span>^<span class="number">64</span> + Ylow</span><br><span class="line">	X * Y = (Xhigh * Yhigh * <span class="number">2</span>^<span class="number">128</span> + <span class="number">2</span>^<span class="number">64</span> * (Xhigh * Ylow + Yhigh * Xlow) + Xlow * Ylow) mod <span class="number">2</span>^<span class="number">128</span></span><br><span class="line">	X * Y = <span class="number">2</span>^<span class="number">64</span> * (Xhigh * Ylow + Yhigh * Xlow) + Xlow * Ylow</span><br><span class="line"></span><br><span class="line">store_prod:</span><br><span class="line">	movq  %rdx, %rax		;%rax = Ylow</span><br><span class="line">	cqto					;sign extend. %rdx = Yhigh, %rax = Ylow</span><br><span class="line">	movq  %rsi, %rcx		;%rcx = Xlow</span><br><span class="line">	sarq  %<span class="number">63</span> , %rcx		;%rcx = Xhigh </span><br><span class="line">	imulq %rax, %rcx		;%rcx = Xhigh * Ylow</span><br><span class="line">	imulq %rsi, %rdx		;%rdx = Yhigh * Xlow</span><br><span class="line">	addq  %rdx, %rcx		;%rcx = Xhigh * Ylow + Yhigh * Xlow</span><br><span class="line">	mulq  %rsi				;[%rdx : %rax] = x * y</span><br><span class="line">	addq  %rcx, %rdx		;%rdx += Xhigh * Ylow + Yhigh * Xlow</span><br><span class="line">	movq  %rax, (%rdi)		</span><br><span class="line">	movq  %rdx, <span class="number">8</span>(%rdi)</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>

<h2 id="3-60"><a href="#3-60" class="headerlink" title="3.60"></a>3.60</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">loop</span><span class="params">(<span class="type">long</span> x, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">	<span class="type">long</span> result = <span class="number">0</span>;</span><br><span class="line">	<span class="type">long</span> mask;</span><br><span class="line">	<span class="keyword">for</span> (mask = <span class="number">1</span>; mask != <span class="number">0</span>; mask = mask &lt;&lt; n) &#123;</span><br><span class="line">		result |= x &amp; mask;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-61"><a href="#3-61" class="headerlink" title="3.61"></a>3.61</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">cread_alt</span><span class="params">(<span class="type">long</span>* xp)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (xp == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> FALSE;</span><br><span class="line">	<span class="keyword">return</span> *xp;</span><br><span class="line">FALSE:</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-62"><a href="#3-62" class="headerlink" title="3.62"></a>3.62</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Enumerated type creates set of constants numbered 0 and upward */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span> MODE_A, MODE_B, MODE_C, MODE_D, MODE_E &#125; <span class="type">mode_t</span>;</span><br><span class="line"><span class="type">long</span> <span class="title function_">switch3</span><span class="params">(<span class="type">long</span>* p1, <span class="type">long</span>* p2, <span class="type">mode_t</span> action)</span> &#123;</span><br><span class="line">	<span class="type">long</span> result = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">switch</span> (action) &#123;</span><br><span class="line">	<span class="keyword">case</span> MODE_A:</span><br><span class="line">		result = *p2;</span><br><span class="line">		*p2 = *p1;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> MODE_B:</span><br><span class="line">		result = *p1 + *p2;</span><br><span class="line">		*p1 = result;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> MODE_C:</span><br><span class="line">		*p1 = <span class="number">59</span>;</span><br><span class="line">		result = *p2;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> MODE_D:</span><br><span class="line">		*p1 = *p2;</span><br><span class="line">		result = <span class="number">27</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> MODE_E:</span><br><span class="line">		result = <span class="number">27</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		result = <span class="number">12</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-63"><a href="#3-63" class="headerlink" title="3.63"></a>3.63</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">switch_prob</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> n)</span> &#123;</span><br><span class="line">	<span class="type">long</span> result = x;</span><br><span class="line">	n -= <span class="number">0x3c</span>;</span><br><span class="line">	<span class="keyword">switch</span> (n) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">	<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">		result *= <span class="number">8</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">		result &gt;&gt;= <span class="number">3</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">		result *= <span class="number">15</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">		x = result * result;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		result = x + <span class="number">0x4b</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-64"><a href="#3-64" class="headerlink" title="3.64"></a>3.64</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> R 7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T 13</span></span><br><span class="line"><span class="type">long</span> A[R][S][T];</span><br><span class="line"><span class="type">long</span> <span class="title function_">store_ele</span><span class="params">(<span class="type">long</span> i, <span class="type">long</span> j, <span class="type">long</span> k, <span class="type">long</span>* dest)</span> &#123;</span><br><span class="line">	*dest = A[i][j][k];</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">sizeof</span>(A);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *	A. </span></span><br><span class="line"><span class="comment"> *  long A[R][S][T];</span></span><br><span class="line"><span class="comment"> *	&amp;A[i][j][k] = X + L(i * S * T + j * T + k)</span></span><br><span class="line"><span class="comment"> *  </span></span><br><span class="line"><span class="comment"> *	B. R = 7, S = 5, T = 13</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<h2 id="3-65"><a href="#3-65" class="headerlink" title="3.65"></a>3.65</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> M 15</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">transpose</span><span class="params">(<span class="type">long</span> A[M][M])</span> &#123;</span><br><span class="line">	<span class="type">long</span> i, j;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; M; i++ )</span><br><span class="line">		<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; i; j++) &#123;</span><br><span class="line">			<span class="type">long</span> t = A[i][j];</span><br><span class="line">			A[i][j] = A[j][i];</span><br><span class="line">			A[j][i] = t;</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *	A.%rdx</span></span><br><span class="line"><span class="comment"> *	B.%rax</span></span><br><span class="line"><span class="comment"> *	C.M = 15</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<h2 id="3-66"><a href="#3-66" class="headerlink" title="3.66"></a>3.66</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> NR(n) (3 * (n))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NC(n) (4 * (n) + 1)</span></span><br><span class="line"><span class="type">long</span> <span class="title function_">sum_col</span><span class="params">(<span class="type">long</span> n, <span class="type">long</span> A[NR(n)][NC(n)], <span class="type">long</span> j)</span> &#123;</span><br><span class="line">	<span class="type">long</span> i;</span><br><span class="line">	<span class="type">long</span> result = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NR(n); i++)</span><br><span class="line">		result += A[i][j];</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-67"><a href="#3-67" class="headerlink" title="3.67"></a>3.67</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">A. (%rsp) = x</span><br><span class="line">  <span class="number">8</span>(%rsp) = y</span><br><span class="line"> <span class="number">16</span>(%rsp) = &amp;z</span><br><span class="line"> <span class="number">24</span>(%rsp) = z</span><br><span class="line">B.  %rsp + <span class="number">64</span></span><br><span class="line">C.  %rsp + bias</span><br><span class="line">D.  %rdi + bias</span><br><span class="line">E.  %rsp + <span class="number">64</span> -&gt; y</span><br><span class="line">	%rsp + <span class="number">72</span> -&gt; x</span><br><span class="line">	%rsp + <span class="number">80</span> -&gt; z</span><br><span class="line">F. 结构体传递参数或作为返回值均为其首地址值</span><br></pre></td></tr></table></figure>

<h2 id="3-68"><a href="#3-68" class="headerlink" title="3.68"></a>3.68</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">setVal:</span><br><span class="line">	movslq	<span class="number">8</span>(%rsi), %rax	;<span class="number">5</span> &lt;= B &lt;= <span class="number">8</span></span><br><span class="line">	addq	<span class="number">32</span>(%rsi), %rax	;<span class="number">7</span> &lt;= A &lt;= <span class="number">10</span></span><br><span class="line"></span><br><span class="line">	movq	%rax, <span class="number">184</span>(%rdi)	;<span class="number">180</span> &lt;= <span class="number">4</span> * A * B &lt;= <span class="number">184</span></span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">	A = <span class="number">9</span>, B = <span class="number">5</span></span><br></pre></td></tr></table></figure>

<h2 id="3-69"><a href="#3-69" class="headerlink" title="3.69"></a>3.69</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">A. CNT = <span class="number">7</span></span><br><span class="line">B. </span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="type">long</span> idx;</span><br><span class="line">	<span class="type">long</span> x[<span class="number">4</span>];</span><br><span class="line">&#125; a_struct;</span><br></pre></td></tr></table></figure>

<h2 id="3-70"><a href="#3-70" class="headerlink" title="3.70"></a>3.70</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">A.e1.p		<span class="number">0</span></span><br><span class="line">  e1.y		<span class="number">8</span></span><br><span class="line">  e2.x		<span class="number">0</span></span><br><span class="line">  e2.next	<span class="number">8</span></span><br><span class="line">B<span class="number">.16</span></span><br><span class="line">C.</span><br><span class="line"><span class="type">void</span> <span class="title function_">proc</span><span class="params">(<span class="keyword">union</span> ele* up)</span> &#123;</span><br><span class="line">	up-&gt;e2.x = *(up-&gt;e2.next-&gt;e1.p) - up-&gt;e2.next-&gt;e1.y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-71"><a href="#3-71" class="headerlink" title="3.71"></a>3.71</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> BUF_SIZE 4</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">good_echo</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	<span class="type">char</span> buf[BUF_SIZE];</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="type">char</span>* p = fgets(buf, BUF_SIZE, <span class="built_in">stdin</span>);</span><br><span class="line">		<span class="keyword">if</span> (ferror(<span class="built_in">stdin</span>) || p == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="built_in">fputs</span>(buf, <span class="built_in">stdout</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-72"><a href="#3-72" class="headerlink" title="3.72"></a>3.72</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">A. s2 = s1 - (<span class="number">8</span> * n + <span class="number">16</span>) ;n为偶数</span><br><span class="line">   s2 = s1 - (<span class="number">8</span> * n + <span class="number">24</span>) ;n为奇数</span><br><span class="line">B.  p = (s2 + <span class="number">15</span>) &amp; <span class="number">0xFFFFFFF0</span></span><br><span class="line">C. 使e1最小: n为奇数, s1 mod <span class="number">16</span> = <span class="number">0</span></span><br><span class="line">   使e1最大: n为偶数, s1 mod <span class="number">16</span> = <span class="number">1</span></span><br><span class="line">D. s2 保留s1的偏移量为最接近的<span class="number">16</span>的倍数		p <span class="number">16</span>对齐</span><br></pre></td></tr></table></figure>

<h2 id="3-73"><a href="#3-73" class="headerlink" title="3.73"></a>3.73</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span>NEG, ZERO, POS, OTHER&#125; <span class="type">range_t</span>;</span><br><span class="line"></span><br><span class="line">find_range:</span><br><span class="line">	movl		$<span class="number">0</span>, %eax				;<span class="built_in">set</span> %rax = <span class="number">0</span></span><br><span class="line">	vxorps		%xmm1, %xmm1, %xmm1		;<span class="built_in">set</span> %xmm1 = <span class="number">0</span></span><br><span class="line">	vucomiss	%xmm1, %xmm0			;Compare x:<span class="number">0</span></span><br><span class="line">	jp			.L5						;If NaN</span><br><span class="line">	jz			.L6						;If x = <span class="number">0</span></span><br><span class="line">	jc			.L7						;If x &lt; <span class="number">0</span></span><br><span class="line">	addl		$<span class="number">2</span>, %eax				;x &gt; <span class="number">0</span></span><br><span class="line">	rep; ret</span><br><span class="line">.L5:</span><br><span class="line">	addl		$<span class="number">2</span>, %eax</span><br><span class="line">.L6:</span><br><span class="line">	addl		$<span class="number">1</span>, $eax</span><br><span class="line">.L7:</span><br><span class="line">	rep; ret</span><br></pre></td></tr></table></figure>

<h2 id="3-74"><a href="#3-74" class="headerlink" title="3.74"></a>3.74</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span>NEG, ZERO, POS, OTHER&#125; <span class="type">range_t</span>;</span><br><span class="line"></span><br><span class="line">find_range:</span><br><span class="line">	movl		$<span class="number">2</span>, %eax				;Assume x is POS	</span><br><span class="line">	vxorps		%xmm1, %xmm1, %xmm1		;<span class="built_in">set</span> %xmm1 = <span class="number">0</span></span><br><span class="line">	vucomiss	%xmm1, %xmm0			;Compare x:<span class="number">0</span></span><br><span class="line">	movq		$<span class="number">0</span>, %rdx</span><br><span class="line">	cmovs		%rdx, %rax				;If CF = <span class="number">1</span>, %rax = <span class="number">0</span>, x may be NEG or NaN</span><br><span class="line">	movq		$<span class="number">1</span>, %rdx</span><br><span class="line">	cmove		%rdx, %rax				;If ZF = <span class="number">1</span>, %rax = <span class="number">1</span>, x may be ZERO or NaN</span><br><span class="line">	movq		%<span class="number">3</span>, %rdx</span><br><span class="line">	cmovp		%rdx, %rax				;If PF = <span class="number">1</span>, %rax = <span class="number">3</span>, x must be NaN</span><br><span class="line">	rep; ret</span><br></pre></td></tr></table></figure>

<h2 id="3-75"><a href="#3-75" class="headerlink" title="3.75"></a>3.75</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A.每个复数类型参数使用两个xmm寄存器分别存储实部和虚部数值, 下标小的存实部</span><br><span class="line">B.若只单独返回实部或单独返回虚部, 将待返回值放于%xmm0寄存器中</span><br><span class="line">  若需返回整个复数,将实部放于%xmm0寄存器中,虚部放于%xmm1寄存器中</span><br></pre></td></tr></table></figure>

<h1 id="Chapter4"><a href="#Chapter4" class="headerlink" title="Chapter4"></a>Chapter4</h1><h2 id="4-45"><a href="#4-45" class="headerlink" title="4.45"></a>4.45</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">A. 	不正确</span><br><span class="line">	正确的pushq应该是先存REG再减%rsp值</span><br><span class="line">   	若按本题所述，pushq %rsp存储的是%rsp - 8的值，而不是原值</span><br><span class="line">B. 	movq %rsp, %rbp</span><br><span class="line">   	subq $8, %rbp</span><br><span class="line">   	movq REG, (%rbp)</span><br><span class="line">   	subq $8, %rsp</span><br></pre></td></tr></table></figure>

<h2 id="4-46"><a href="#4-46" class="headerlink" title="4.46"></a>4.46</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A. 	不正确</span><br><span class="line">	若按本题所述，popq %rsp执行后%rsp中值为%rsp + 8，而不是原值</span><br><span class="line">B.	movq %rsp, %rbp</span><br><span class="line">	addq $8, %rsp</span><br><span class="line">	movq (%rbp), REG</span><br></pre></td></tr></table></figure>

<h2 id="4-47"><a href="#4-47" class="headerlink" title="4.47"></a>4.47</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">A.</span><br><span class="line"><span class="comment">/* Bubble sort: Pointer version */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">bubble_p</span><span class="params">(<span class="type">long</span>* data, <span class="type">long</span> count)</span> &#123;</span><br><span class="line">    <span class="type">long</span> i, last;</span><br><span class="line">    <span class="keyword">for</span> (last = count - <span class="number">1</span>; last &gt; <span class="number">0</span>; last--) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; last; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (*(data + i + <span class="number">1</span>) &lt; *(data + i)) &#123;</span><br><span class="line">                <span class="comment">/* Swap adjacent elements */</span></span><br><span class="line">                <span class="type">long</span> t = *(data + i + <span class="number">1</span>);</span><br><span class="line">                *(data + i + <span class="number">1</span>) = *(data + i);</span><br><span class="line">                *(data + i) = t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">B.</span><br><span class="line"># void bubble_p(long* data, long count)</span><br><span class="line"># data in %rdi, count in %rsi</span><br><span class="line">bubble_p:</span><br><span class="line">	irmovq $1, %r8</span><br><span class="line">	rrmovq %rsi, %r9		;%r9: last</span><br><span class="line">loop1:</span><br><span class="line">	subq %r8, %r9</span><br><span class="line">	andq %r9, %r9</span><br><span class="line">	je done</span><br><span class="line">	irmovq $0, %rax			;%rax: i </span><br><span class="line">loop2:</span><br><span class="line">	rrmovq %rax, %r11</span><br><span class="line">	subq %r9, %r11			;%r11 = i - last</span><br><span class="line">	je next</span><br><span class="line">	rrmovq %rax, %r11		;%r11 = i</span><br><span class="line">	addq %r8, %r11			;%r11 = i + 1</span><br><span class="line">	addq %r11, %r11</span><br><span class="line">	addq %r11, %r11</span><br><span class="line">	addq %r11, %r11			;%r11 = 8 * (i + 1)</span><br><span class="line">	addq %rdi, %r11			;%r11 = &amp;*(data +i + 1)</span><br><span class="line">	mrmovq (%r11), %rbx		;%rbx = *(data + i + 1)</span><br><span class="line">	</span><br><span class="line">	rrmovq %rax, %r12		;%r12 = i</span><br><span class="line">	addq %r12, %r12</span><br><span class="line">	addq %r12, %r12</span><br><span class="line">	addq %r12, %r12			;%r12 = 8 * i</span><br><span class="line">	addq %rdi, %r12			;%r12 = &amp;*(data +i)</span><br><span class="line">	mrmovq (%r12), %rcx		;%rcx = *(data + i)</span><br><span class="line">	</span><br><span class="line">	rrmovq %rbx, %r13</span><br><span class="line">	subq %rcx, %r13			;%r13 = *(data + i + 1) - *(data + i)</span><br><span class="line">	jge	no_need</span><br><span class="line">	rmmovq %rbx, (%r12)</span><br><span class="line">	rmmovq %rcx, (%r11)</span><br><span class="line">no_need:</span><br><span class="line">	addq %r8, %rax</span><br><span class="line">	jmp loop2</span><br><span class="line">next:</span><br><span class="line">	jmp loop1</span><br><span class="line">done:</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>

<h2 id="4-48"><a href="#4-48" class="headerlink" title="4.48"></a>4.48</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">rrmovq %rax, %r11		;%r11 = i</span><br><span class="line">addq %r8, %r11			;%r11 = i + 1</span><br><span class="line">addq %r11, %r11</span><br><span class="line">addq %r11, %r11</span><br><span class="line">addq %r11, %r11			;%r11 = 8 * (i + 1)</span><br><span class="line">addq %rdi, %r11			;%r11 = &amp;*(data +i + 1)</span><br><span class="line">mrmovq (%r11), %rbx		;%rbx = *(data + i + 1)</span><br><span class="line"></span><br><span class="line">rrmovq %rax, %r12		;%r12 = i</span><br><span class="line">addq %r12, %r12</span><br><span class="line">addq %r12, %r12</span><br><span class="line">addq %r12, %r12			;%r12 = 8 * i</span><br><span class="line">addq %rdi, %r12			;%r12 = &amp;*(data +i)</span><br><span class="line">mrmovq (%r12), %rcx		;%rcx = *(data + i)</span><br><span class="line"></span><br><span class="line">rrmovq %rbx, %r13</span><br><span class="line">subq %rcx, %r13			;%r13 = *(data + i + 1) - *(data + i)</span><br><span class="line">cmovl %rbx, %r13</span><br><span class="line">cmovl %rcx, %rbx</span><br><span class="line">cmovl %r13, %rcx</span><br><span class="line">mrmovq (%r11), %rbx</span><br><span class="line">mrmovq (%r12), %rcx</span><br></pre></td></tr></table></figure>

<h2 id="4-49"><a href="#4-49" class="headerlink" title="4.49"></a>4.49</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">rrmovq %rax, %r11		;%r11 = i</span><br><span class="line">addq %r8, %r11			;%r11 = i + 1</span><br><span class="line">addq %r11, %r11</span><br><span class="line">addq %r11, %r11</span><br><span class="line">addq %r11, %r11			;%r11 = 8 * (i + 1)</span><br><span class="line">addq %rdi, %r11			;%r11 = &amp;*(data +i + 1)</span><br><span class="line">mrmovq (%r11), %rbx		;%rbx = *(data + i + 1)</span><br><span class="line"></span><br><span class="line">rrmovq %rax, %r12		;%r12 = i</span><br><span class="line">addq %r12, %r12</span><br><span class="line">addq %r12, %r12</span><br><span class="line">addq %r12, %r12			;%r12 = 8 * i</span><br><span class="line">addq %rdi, %r12			;%r12 = &amp;*(data +i)</span><br><span class="line">mrmovq (%r12), %rcx		;%rcx = *(data + i)</span><br><span class="line"></span><br><span class="line">rrmovq %rbx, %r13</span><br><span class="line">subq %rcx, %r13			;%r13 = *(data + i + 1) - *(data + i)</span><br><span class="line">rmmovq %rcx, (%r11)		;now, *(data + i + 1) = *(data + i)</span><br><span class="line">rrmovq %r11, %r13		;%r13 = &amp;*(data + i + 1)</span><br><span class="line">cmovl %r12, %r13		;if (initial data[i + 1] &lt; initial data[i]), %r13 = &amp;*(data + i)</span><br><span class="line">rmmovq %rbx, (%r13)		;(%r13) = initial data[i + 1]</span><br></pre></td></tr></table></figure>

<h2 id="4-50"><a href="#4-50" class="headerlink" title="4.50"></a>4.50</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">;long switchv(long idx)</span><br><span class="line">;idx in %rdi</span><br><span class="line">switchv:</span><br><span class="line">	irmovq $5, %r8</span><br><span class="line">	subq %r8, %rdi</span><br><span class="line">	jg default</span><br><span class="line">	addq %rdi, %rdi</span><br><span class="line">	addq %rdi, %rdi</span><br><span class="line">	addq %rdi, %rdi</span><br><span class="line">	irmovq table, %r8</span><br><span class="line">	addq %r8, %rdi</span><br><span class="line">	pushq %rdi</span><br><span class="line">	ret</span><br><span class="line">case_0:</span><br><span class="line">	irmovq $0xaaa, %rax</span><br><span class="line">	jmp done</span><br><span class="line">case_2_5:</span><br><span class="line">	irmovq $0xbbb, %rax</span><br><span class="line">	jmp done</span><br><span class="line">case_3:</span><br><span class="line">	irmovq $0xccc, %rax</span><br><span class="line">	jmp done</span><br><span class="line">default:</span><br><span class="line">	irmovq $0xddd, %rax</span><br><span class="line">done:</span><br><span class="line">	ret</span><br><span class="line">	</span><br><span class="line">	.align 8</span><br><span class="line">table:</span><br><span class="line">	.quad	case_0</span><br><span class="line">	.quad	default</span><br><span class="line">	.quad	case_2_5</span><br><span class="line">	.quad	case_3</span><br><span class="line">	.quad	default</span><br><span class="line">	.quad	case_2_5</span><br></pre></td></tr></table></figure>

<h2 id="4-51"><a href="#4-51" class="headerlink" title="4.51"></a>4.51</h2><table>
<thead>
<tr>
<th>阶段</th>
<th>iaddq V, rB</th>
</tr>
</thead>
<tbody><tr>
<td>取指</td>
<td>icode:ifun &lt;– M1[PC]<br />rA:rB &lt;– M1[PC + 1]<br />valC &lt;– M8[PC + 2]<br />valP &lt;– PC + 10</td>
</tr>
<tr>
<td>译码</td>
<td>valB &lt;– R[rB]</td>
</tr>
<tr>
<td>执行</td>
<td>valE &lt;– valB + valC<br />Set CC</td>
</tr>
<tr>
<td>访存</td>
<td></td>
</tr>
<tr>
<td>写回</td>
<td>R[rB] &lt;– valE</td>
</tr>
<tr>
<td>更新PC</td>
<td>PC &lt;– valP</td>
</tr>
</tbody></table>
<h2 id="4-53"><a href="#4-53" class="headerlink" title="4.53"></a>4.53</h2><p>没有pipe-stall.hcl文件，经查证本题所用文件应为pipe-nobypass.hcl</p>
<h2 id="4-57"><a href="#4-57" class="headerlink" title="4.57"></a>4.57</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A. 加载/转发使用冒险	 M_icode in &#123; IMRMOVQ, IPOPQ &#125; &amp;&amp; E_icode in &#123; IPUSHQ &#125; &amp;&amp; M_dstM == E_valA</span><br></pre></td></tr></table></figure>

<h2 id="4-58"><a href="#4-58" class="headerlink" title="4.58"></a>4.58</h2><p>放弃</p>
<h2 id="4-59"><a href="#4-59" class="headerlink" title="4.59"></a>4.59</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">4.49的版本好</span><br><span class="line">首先，4.47猜用跳转指令实现功能，大量的分支预测错误大幅降低效率</span><br><span class="line">而4.49相比于4.48只使用一次条件传送，效率更高</span><br></pre></td></tr></table></figure>

<h1 id="Chapter5"><a href="#Chapter5" class="headerlink" title="Chapter5"></a>Chapter5</h1><h2 id="5-14"><a href="#5-14" class="headerlink" title="5.14"></a>5.14</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 6 x 1 loop unrolling */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">inner5</span><span class="params">(vec_ptr u, vec_ptr v, <span class="type">data_t</span>* dest)</span> &#123;</span><br><span class="line">    <span class="type">long</span> i;</span><br><span class="line">    <span class="type">long</span> length = vec_length(u);</span><br><span class="line">    <span class="type">data_t</span>* updata = get_vec_start(u);</span><br><span class="line">    <span class="type">data_t</span>* vdata = get_vec_start(v);</span><br><span class="line">    <span class="type">data_t</span> sum = (<span class="type">data_t</span>) <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (length &gt;= <span class="number">6</span>) &#123;</span><br><span class="line">        <span class="comment">/* Combine 6 elements at a time */</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; length; i += <span class="number">6</span>) &#123;</span><br><span class="line">        sum += udata[i] * vdata[i]; </span><br><span class="line">        sum += udata[i + <span class="number">1</span>] * vdata[i + <span class="number">1</span>]; </span><br><span class="line">        sum += udata[i + <span class="number">2</span>] * vdata[i + <span class="number">2</span>]; </span><br><span class="line">        sum += udata[i + <span class="number">3</span>] * vdata[i + <span class="number">3</span>]; </span><br><span class="line">        sum += udata[i + <span class="number">4</span>] * vdata[i + <span class="number">4</span>]; </span><br><span class="line">        sum += udata[i + <span class="number">5</span>] * vdata[i + <span class="number">5</span>]; </span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Finish any remaining elements */</span></span><br><span class="line">    <span class="keyword">for</span> (; i &lt; length; i++)</span><br><span class="line">        sum += updata[i] * vdata[i];</span><br><span class="line">    *dest = sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-15"><a href="#5-15" class="headerlink" title="5.15"></a>5.15</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 6 x 6 loop unrolling */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">inner6</span><span class="params">(vec_ptr u, vec_ptr v, <span class="type">data_t</span>* dest)</span> &#123;</span><br><span class="line">    <span class="type">long</span> i;</span><br><span class="line">    <span class="type">long</span> length = vec_length(u);</span><br><span class="line">    <span class="type">data_t</span>* updata = get_vec_start(u);</span><br><span class="line">    <span class="type">data_t</span>* vdata = get_vec_start(v);</span><br><span class="line">    <span class="type">data_t</span> sum1 = (<span class="type">data_t</span>) <span class="number">0</span>;</span><br><span class="line">    <span class="type">data_t</span> sum2 = (<span class="type">data_t</span>) <span class="number">0</span>;</span><br><span class="line">    <span class="type">data_t</span> sum3 = (<span class="type">data_t</span>) <span class="number">0</span>;</span><br><span class="line">    <span class="type">data_t</span> sum4 = (<span class="type">data_t</span>) <span class="number">0</span>;</span><br><span class="line">    <span class="type">data_t</span> sum5 = (<span class="type">data_t</span>) <span class="number">0</span>;</span><br><span class="line">    <span class="type">data_t</span> sum6 = (<span class="type">data_t</span>) <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (length &gt;= <span class="number">6</span>) &#123;</span><br><span class="line">        <span class="comment">/* Combine 6 elements at a time */</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; length; i += <span class="number">6</span>) &#123;</span><br><span class="line">        sum1 += udata[i] * vdata[i]; </span><br><span class="line">        sum2 += udata[i + <span class="number">1</span>] * vdata[i + <span class="number">1</span>]; </span><br><span class="line">        sum3 += udata[i + <span class="number">2</span>] * vdata[i + <span class="number">2</span>]; </span><br><span class="line">        sum4 += udata[i + <span class="number">3</span>] * vdata[i + <span class="number">3</span>]; </span><br><span class="line">        sum5 += udata[i + <span class="number">4</span>] * vdata[i + <span class="number">4</span>]; </span><br><span class="line">        sum6 += udata[i + <span class="number">5</span>] * vdata[i + <span class="number">5</span>]; </span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Finish any remaining elements */</span></span><br><span class="line">    <span class="keyword">for</span> (; i &lt; length; i++)</span><br><span class="line">        sum1 += updata[i] * vdata[i];</span><br><span class="line">    *dest = sum1 + sum2 + sum3 +sum4 +sum5 +sum6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-16"><a href="#5-16" class="headerlink" title="5.16"></a>5.16</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 6 x 1a loop unrolling */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">inner5</span><span class="params">(vec_ptr u, vec_ptr v, <span class="type">data_t</span>* dest)</span> &#123;</span><br><span class="line">    <span class="type">long</span> i;</span><br><span class="line">    <span class="type">long</span> length = vec_length(u);</span><br><span class="line">    <span class="type">data_t</span>* updata = get_vec_start(u);</span><br><span class="line">    <span class="type">data_t</span>* vdata = get_vec_start(v);</span><br><span class="line">    <span class="type">data_t</span> sum = (<span class="type">data_t</span>) <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (length &gt;= <span class="number">6</span>) &#123;</span><br><span class="line">        <span class="comment">/* Combine 6 elements at a time */</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; length; i += <span class="number">6</span>) &#123;</span><br><span class="line">        sum += udata[i] * vdata[i] + udata[i + <span class="number">1</span>] * vdata[i + <span class="number">1</span>] +</span><br><span class="line">			   udata[i + <span class="number">2</span>] * vdata[i + <span class="number">2</span>] + udata[i + <span class="number">3</span>] * vdata[i + <span class="number">3</span>] +</span><br><span class="line">               udata[i + <span class="number">4</span>] * vdata[i + <span class="number">4</span>] + udata[i + <span class="number">5</span>] * vdata[i + <span class="number">5</span>];</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Finish any remaining elements */</span></span><br><span class="line">    <span class="keyword">for</span> (; i &lt; length; i++)</span><br><span class="line">        sum += updata[i] * vdata[i];</span><br><span class="line">    *dest = sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-17"><a href="#5-17" class="headerlink" title="5.17"></a>5.17</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span>* <span class="title function_">optimized_memset</span><span class="params">(<span class="type">void</span>* s, <span class="type">int</span> c, <span class="type">size_t</span> n)</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> i, j, longc, K = <span class="keyword">sizeof</span>(<span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>* schar = s;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> charc = (<span class="type">unsigned</span> <span class="type">char</span>)c;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">8</span>, j = K &lt;&lt; <span class="number">3</span>, longc = charc; i &lt; j; i *= <span class="number">2</span>) &#123;</span><br><span class="line">        longc = (longc &lt;&lt; i) | longc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ((<span class="type">unsigned</span> <span class="type">long</span>)s % K != <span class="number">0</span> &amp;&amp; cnt &lt; n) &#123;</span><br><span class="line">        *schar++ = charc;</span><br><span class="line">        cnt++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>* p = (<span class="type">unsigned</span> <span class="type">long</span>*)s;</span><br><span class="line">    <span class="keyword">if</span> (n &gt;= cnt + K)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (; cnt &lt; n; cnt += K) &#123;</span><br><span class="line">            *p++ = longc;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    schar = (<span class="type">unsigned</span> <span class="type">char</span>*)p;</span><br><span class="line">    <span class="keyword">while</span> (cnt &lt; n) &#123;</span><br><span class="line">        *schar++ = charc;</span><br><span class="line">        cnt++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-18"><a href="#5-18" class="headerlink" title="5.18"></a>5.18</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">double</span> <span class="title function_">polyh</span><span class="params">(<span class="type">double</span> a[], <span class="type">double</span> x, <span class="type">long</span> degree)</span> &#123;</span><br><span class="line">    <span class="type">long</span> i;</span><br><span class="line">    <span class="type">double</span> acc1 = a[<span class="number">0</span>], acc2 = <span class="number">0</span>, acc3 = <span class="number">0</span>, acc4 = <span class="number">0</span>, result;</span><br><span class="line">    <span class="type">double</span> xpwr = x, xpwr_1, xpwr_2, xpwr_3;</span><br><span class="line">    <span class="type">double</span> xp1 = x;</span><br><span class="line">    <span class="type">double</span> xp2 = x * x;</span><br><span class="line">    <span class="type">double</span> xp3 = x * x * x;</span><br><span class="line">    <span class="type">double</span> xp4 = x * x * x * x;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">4</span>; i &lt;= degree; i += <span class="number">4</span>) &#123;</span><br><span class="line">        xpwr_1 = xpwr * xp1;</span><br><span class="line">        xpwr_2 = xpwr * xp2;</span><br><span class="line">        xpwr_3 = xpwr * xp3;</span><br><span class="line">        acc1 += a[i - <span class="number">3</span>] * xpwr;       </span><br><span class="line">        acc2 += a[i - <span class="number">2</span>] * xpwr_1;</span><br><span class="line">        acc3 += a[i - <span class="number">1</span>] * xpwr_2;</span><br><span class="line">        acc4 += a[i] * xpwr_3;</span><br><span class="line">        xpwr *= xp4;</span><br><span class="line">    &#125;</span><br><span class="line">    i -= <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt;= degree) &#123;</span><br><span class="line">        acc1 += a[i++] * xpwr;</span><br><span class="line">        xpwr *= x;</span><br><span class="line">    &#125;</span><br><span class="line">    result = acc1 + acc2 + acc3 + acc4;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-19"><a href="#5-19" class="headerlink" title="5.19"></a>5.19</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">psum1</span><span class="params">(<span class="type">float</span> a[], <span class="type">float</span> p[], <span class="type">long</span> n)</span> &#123;</span><br><span class="line">    <span class="type">long</span> i;</span><br><span class="line">    <span class="type">float</span> acc0 = a[<span class="number">0</span>], acc1 = a[<span class="number">0</span>];</span><br><span class="line">    p[<span class="number">0</span>] = a[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">2</span>; i &lt; n; i += <span class="number">2</span>) &#123;</span><br><span class="line">        acc0 += a[i - <span class="number">1</span>];</span><br><span class="line">        acc1 += a[i - <span class="number">1</span>] + a[i];</span><br><span class="line">        p[i- <span class="number">1</span>] = acc0;</span><br><span class="line">        p[i] = acc1;</span><br><span class="line">        acc0 += a[i];</span><br><span class="line">    &#125;</span><br><span class="line">    i--;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; n) &#123;</span><br><span class="line">        p[i] = p[i - <span class="number">1</span>] + a[i++];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Chapter6"><a href="#Chapter6" class="headerlink" title="Chapter6"></a>Chapter6</h1><h2 id="6-22"><a href="#6-22" class="headerlink" title="6.22"></a>6.22</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">圆洞周长：2 * pi * x * r</span><br><span class="line">磁道数正比于: 1 - x</span><br><span class="line">容量： 2 * pi * x * r * (1 - x) = 2 * pi * x * r - 2 * pi * (x^2) * r</span><br><span class="line">当x = 0.5时磁盘容量最大</span><br></pre></td></tr></table></figure>

<h2 id="6-23"><a href="#6-23" class="headerlink" title="6.23"></a>6.23</h2><p>$T_{avg seek} &#x3D; 4ms$</p>
<p>$T_{avg rotation} &#x3D; \frac{1}{2} * \frac{60s}{15000} * \frac{1000ms}{1s} &#x3D; 2ms$</p>
<p>$T_{avg transfer} &#x3D; \frac{1}{15000} * \frac{1}{800} * \frac{60s}{1min} * \frac{1000ms}{1s} &#x3D; 0.005ms$</p>
<p>$T_{access} &#x3D; T_{avg seek} + T_{avg rotation} + T_{avg transfer} &#x3D; 6.005ms$</p>
<h2 id="6-24"><a href="#6-24" class="headerlink" title="6.24"></a>6.24</h2><p>$T_{avg seek} &#x3D; 4ms$</p>
<p>$T_{avg rotation} &#x3D; \frac{1}{2} * \frac{60s}{15000} * \frac{1000ms}{1s} &#x3D; 2ms$</p>
<p>2MB大小的文件，一个逻辑块存放512字节，需要4096个逻辑块</p>
<p>最好情况：$T &#x3D; T_{avg seek} + T_{avg rotation} + \frac{4096}{1000} * T_{max ratation} &#x3D; 22.384ms$</p>
<p>最坏情况：$T &#x3D;  (T_{avg seek} + T_{avg rotation}) * 4096 * \frac{1s}{1000ms} &#x3D; 24.576s$</p>
<h2 id="6-25"><a href="#6-25" class="headerlink" title="6.25"></a>6.25</h2><table>
<thead>
<tr>
<th align="center">高速缓存</th>
<th align="center">m</th>
<th align="center">C</th>
<th align="center">B</th>
<th align="center">E</th>
<th align="center">S</th>
<th align="center">t</th>
<th align="center">s</th>
<th align="center">b</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1.</td>
<td align="center">32</td>
<td align="center">1024</td>
<td align="center">4</td>
<td align="center">4</td>
<td align="center">64</td>
<td align="center">24</td>
<td align="center">6</td>
<td align="center">2</td>
</tr>
<tr>
<td align="center">2.</td>
<td align="center">32</td>
<td align="center">1024</td>
<td align="center">4</td>
<td align="center">256</td>
<td align="center">2</td>
<td align="center">29</td>
<td align="center">1</td>
<td align="center">2</td>
</tr>
<tr>
<td align="center">3.</td>
<td align="center">32</td>
<td align="center">1024</td>
<td align="center">8</td>
<td align="center">1</td>
<td align="center">128</td>
<td align="center">22</td>
<td align="center">7</td>
<td align="center">3</td>
</tr>
<tr>
<td align="center">4.</td>
<td align="center">32</td>
<td align="center">1024</td>
<td align="center">8</td>
<td align="center">128</td>
<td align="center">1</td>
<td align="center">29</td>
<td align="center">0</td>
<td align="center">3</td>
</tr>
<tr>
<td align="center">5.</td>
<td align="center">32</td>
<td align="center">1024</td>
<td align="center">32</td>
<td align="center">1</td>
<td align="center">32</td>
<td align="center">22</td>
<td align="center">5</td>
<td align="center">5</td>
</tr>
<tr>
<td align="center">6.</td>
<td align="center">32</td>
<td align="center">1024</td>
<td align="center">32</td>
<td align="center">4</td>
<td align="center">8</td>
<td align="center">24</td>
<td align="center">3</td>
<td align="center">5</td>
</tr>
</tbody></table>
<h2 id="6-26"><a href="#6-26" class="headerlink" title="6.26"></a>6.26</h2><table>
<thead>
<tr>
<th align="center">高速缓存</th>
<th align="center">m</th>
<th align="center">C</th>
<th align="center">B</th>
<th align="center">E</th>
<th align="center">S</th>
<th align="center">t</th>
<th align="center">s</th>
<th align="center">b</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1.</td>
<td align="center">32</td>
<td align="center">2048</td>
<td align="center">8</td>
<td align="center">1</td>
<td align="center">256</td>
<td align="center">21</td>
<td align="center">8</td>
<td align="center">3</td>
</tr>
<tr>
<td align="center">2.</td>
<td align="center">32</td>
<td align="center">2048</td>
<td align="center">4</td>
<td align="center">8</td>
<td align="center">128</td>
<td align="center">23</td>
<td align="center">7</td>
<td align="center">2</td>
</tr>
<tr>
<td align="center">3.</td>
<td align="center">32</td>
<td align="center">1024</td>
<td align="center">2</td>
<td align="center">8</td>
<td align="center">64</td>
<td align="center">25</td>
<td align="center">6</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">4.</td>
<td align="center">32</td>
<td align="center">1024</td>
<td align="center">32</td>
<td align="center">2</td>
<td align="center">16</td>
<td align="center">23</td>
<td align="center">4</td>
<td align="center">5</td>
</tr>
</tbody></table>
<h2 id="6-27"><a href="#6-27" class="headerlink" title="6.27"></a>6.27</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A. 0x8a4 ~ 0x8a7, 0xe04 ~ 0xe07</span><br><span class="line">B. 0x1238 ~ 0x123b</span><br></pre></td></tr></table></figure>

<h2 id="6-28"><a href="#6-28" class="headerlink" title="6.28"></a>6.28</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">A. NONE</span><br><span class="line">B. 0x18f0 ~ 0x18f3</span><br><span class="line">C. 0xb0 ~ 0xb3</span><br><span class="line">D. 0x1bdc ~ 0x1bdf</span><br></pre></td></tr></table></figure>

<h2 id="6-29"><a href="#6-29" class="headerlink" title="6.29"></a>6.29</h2><table>
<thead>
<tr>
<th align="center">CT</th>
<th align="center">CT</th>
<th align="center">CT</th>
<th align="center">CT</th>
<th align="center">CT</th>
<th align="center">CT</th>
<th align="center">CT</th>
<th align="center">CT</th>
<th align="center">CI</th>
<th align="center">CI</th>
<th align="center">CO</th>
<th align="center">CO</th>
</tr>
</thead>
</table>
<table>
<thead>
<tr>
<th align="center">操作</th>
<th align="center">地址</th>
<th align="center">命中？</th>
<th align="center">读出的值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">读</td>
<td align="center">0x834</td>
<td align="center">miss</td>
<td align="center">0xFE</td>
</tr>
<tr>
<td align="center">写</td>
<td align="center">0x836</td>
<td align="center">hit</td>
<td align="center">—-</td>
</tr>
<tr>
<td align="center">读</td>
<td align="center">0xFFD</td>
<td align="center">hit</td>
<td align="center">0xC0</td>
</tr>
</tbody></table>
<h2 id="6-30"><a href="#6-30" class="headerlink" title="6.30"></a>6.30</h2><p>$C &#x3D; B * E * S &#x3D; 128$</p>
<table>
<thead>
<tr>
<th align="center">CT</th>
<th align="center">CT</th>
<th align="center">CT</th>
<th align="center">CT</th>
<th align="center">CT</th>
<th align="center">CT</th>
<th align="center">CT</th>
<th align="center">CT</th>
<th align="center">CI</th>
<th align="center">CI</th>
<th align="center">CI</th>
<th align="center">CO</th>
<th align="center">CO</th>
</tr>
</thead>
</table>
<h2 id="6-31"><a href="#6-31" class="headerlink" title="6.31"></a>6.31</h2><table>
<thead>
<tr>
<th align="center">0</th>
<th align="center">0</th>
<th align="center">1</th>
<th align="center">1</th>
<th align="center">1</th>
<th align="center">0</th>
<th align="center">0</th>
<th align="center">0</th>
<th align="center">1</th>
<th align="center">1</th>
<th align="center">0</th>
<th align="center">1</th>
<th align="center">0</th>
</tr>
</thead>
</table>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">CO</td>
<td align="center">0x2</td>
</tr>
<tr>
<td align="center">CI</td>
<td align="center">0x6</td>
</tr>
<tr>
<td align="center">CT</td>
<td align="center">0x38</td>
</tr>
<tr>
<td align="center">命中？</td>
<td align="center">hit</td>
</tr>
<tr>
<td align="center">返回的高速缓存字节</td>
<td align="center">0xEB</td>
</tr>
</tbody></table>
<h2 id="6-32"><a href="#6-32" class="headerlink" title="6.32"></a>6.32</h2><table>
<thead>
<tr>
<th align="center">1</th>
<th align="center">0</th>
<th align="center">1</th>
<th align="center">1</th>
<th align="center">0</th>
<th align="center">1</th>
<th align="center">1</th>
<th align="center">1</th>
<th align="center">0</th>
<th align="center">1</th>
<th align="center">0</th>
<th align="center">0</th>
<th align="center">0</th>
</tr>
</thead>
</table>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">CO</td>
<td align="center">0x0</td>
</tr>
<tr>
<td align="center">CI</td>
<td align="center">0x2</td>
</tr>
<tr>
<td align="center">CT</td>
<td align="center">0xB7</td>
</tr>
<tr>
<td align="center">命中？</td>
<td align="center">miss</td>
</tr>
<tr>
<td align="center">返回的高速缓存字节</td>
<td align="center">—-</td>
</tr>
</tbody></table>
<h2 id="6-33"><a href="#6-33" class="headerlink" title="6.33"></a>6.33</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x1788 ~ 0x178b, 0x16c8 ~ 0x16cb</span><br></pre></td></tr></table></figure>

<h2 id="6-34"><a href="#6-34" class="headerlink" title="6.34"></a>6.34</h2><p>dst数组</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">col0</th>
<th align="center">col1</th>
<th align="center">col2</th>
<th align="center">col3</th>
</tr>
</thead>
<tbody><tr>
<td align="center">row0</td>
<td align="center">m</td>
<td align="center">m</td>
<td align="center">m</td>
<td align="center">m</td>
</tr>
<tr>
<td align="center">row1</td>
<td align="center">m</td>
<td align="center">m</td>
<td align="center">m</td>
<td align="center">m</td>
</tr>
<tr>
<td align="center">row2</td>
<td align="center">m</td>
<td align="center">m</td>
<td align="center">m</td>
<td align="center">m</td>
</tr>
<tr>
<td align="center">row3</td>
<td align="center">m</td>
<td align="center">m</td>
<td align="center">m</td>
<td align="center">m</td>
</tr>
</tbody></table>
<p>src数组</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">col0</th>
<th align="center">col1</th>
<th align="center">col2</th>
<th align="center">col3</th>
</tr>
</thead>
<tbody><tr>
<td align="center">row0</td>
<td align="center">m</td>
<td align="center">m</td>
<td align="center">h</td>
<td align="center">m</td>
</tr>
<tr>
<td align="center">row1</td>
<td align="center">m</td>
<td align="center">h</td>
<td align="center">m</td>
<td align="center">h</td>
</tr>
<tr>
<td align="center">row2</td>
<td align="center">m</td>
<td align="center">m</td>
<td align="center">h</td>
<td align="center">m</td>
</tr>
<tr>
<td align="center">row3</td>
<td align="center">m</td>
<td align="center">m</td>
<td align="center">h</td>
<td align="center">m</td>
</tr>
</tbody></table>
<h2 id="6-35"><a href="#6-35" class="headerlink" title="6.35"></a>6.35</h2><p>dst数组</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">col0</th>
<th align="center">col1</th>
<th align="center">col2</th>
<th align="center">col3</th>
</tr>
</thead>
<tbody><tr>
<td align="center">row0</td>
<td align="center">m</td>
<td align="center">h</td>
<td align="center">h</td>
<td align="center">h</td>
</tr>
<tr>
<td align="center">row1</td>
<td align="center">m</td>
<td align="center">h</td>
<td align="center">h</td>
<td align="center">h</td>
</tr>
<tr>
<td align="center">row2</td>
<td align="center">m</td>
<td align="center">h</td>
<td align="center">h</td>
<td align="center">h</td>
</tr>
<tr>
<td align="center">row3</td>
<td align="center">m</td>
<td align="center">h</td>
<td align="center">h</td>
<td align="center">h</td>
</tr>
</tbody></table>
<p>src数组</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">col0</th>
<th align="center">col1</th>
<th align="center">col2</th>
<th align="center">col3</th>
</tr>
</thead>
<tbody><tr>
<td align="center">row0</td>
<td align="center">m</td>
<td align="center">h</td>
<td align="center">h</td>
<td align="center">h</td>
</tr>
<tr>
<td align="center">row1</td>
<td align="center">m</td>
<td align="center">h</td>
<td align="center">h</td>
<td align="center">h</td>
</tr>
<tr>
<td align="center">row2</td>
<td align="center">m</td>
<td align="center">h</td>
<td align="center">h</td>
<td align="center">h</td>
</tr>
<tr>
<td align="center">row3</td>
<td align="center">m</td>
<td align="center">h</td>
<td align="center">h</td>
<td align="center">h</td>
</tr>
</tbody></table>
<h2 id="6-36"><a href="#6-36" class="headerlink" title="6.36"></a>6.36</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A. 100%</span><br><span class="line">B. 25%</span><br><span class="line">C. 25%</span><br><span class="line">D. 不能，所有的未命中都是冷缓存导致的</span><br><span class="line">E. 能，如果块更大，能减少部分未命中次数</span><br></pre></td></tr></table></figure>

<h2 id="6-37"><a href="#6-37" class="headerlink" title="6.37"></a>6.37</h2><table>
<thead>
<tr>
<th align="center">函数</th>
<th align="center">N&#x3D;64</th>
<th align="center">N&#x3D;60</th>
</tr>
</thead>
<tbody><tr>
<td align="center">sumA</td>
<td align="center">25%</td>
<td align="center">25%</td>
</tr>
<tr>
<td align="center">sumB</td>
<td align="center">100%</td>
<td align="center">25%</td>
</tr>
<tr>
<td align="center">sumC</td>
<td align="center">50%</td>
<td align="center">25%</td>
</tr>
</tbody></table>
<h2 id="6-38"><a href="#6-38" class="headerlink" title="6.38"></a>6.38</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A. 1024</span><br><span class="line">B. 128</span><br><span class="line">C. 12.5%</span><br></pre></td></tr></table></figure>

<h2 id="6-39"><a href="#6-39" class="headerlink" title="6.39"></a>6.39</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A. 1024</span><br><span class="line">B. 256</span><br><span class="line">C. 25%</span><br></pre></td></tr></table></figure>

<h2 id="6-40"><a href="#6-40" class="headerlink" title="6.40"></a>6.40</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A. 1024</span><br><span class="line">B. 256</span><br><span class="line">C. 25%</span><br></pre></td></tr></table></figure>

<h2 id="6-41"><a href="#6-41" class="headerlink" title="6.41"></a>6.41</h2><p>25%</p>
<h2 id="6-42"><a href="#6-42" class="headerlink" title="6.42"></a>6.42</h2><p>25%</p>
<h2 id="6-43"><a href="#6-43" class="headerlink" title="6.43"></a>6.43</h2><p>100%</p>
<h2 id="6-44"><a href="#6-44" class="headerlink" title="6.44"></a>6.44</h2>

<h2 id="6-45"><a href="#6-45" class="headerlink" title="6.45"></a>6.45</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">transpose</span><span class="params">(<span class="type">int</span>* dst, <span class="type">int</span>* src, <span class="type">int</span> dim)</span> &#123;</span><br><span class="line">    <span class="type">int</span> i, j, acc0, acc1, acc2, acc3, m, n;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; dim; i++) &#123;</span><br><span class="line">        m = i * dim;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">3</span>; j &lt; dim; j += <span class="number">4</span>) &#123;</span><br><span class="line">            n = j * dim;</span><br><span class="line">            acc0 = src[m + j - <span class="number">3</span>];</span><br><span class="line">            acc1 = src[m + j - <span class="number">2</span>];</span><br><span class="line">            acc2 = src[m + j - <span class="number">1</span>];</span><br><span class="line">            acc3 = src[m + j];</span><br><span class="line">            dst[n - dim - dim - dim + i - <span class="number">3</span>] = acc0;</span><br><span class="line">            dst[n - dim - dim + i - <span class="number">2</span>] = acc1;</span><br><span class="line">            dst[n - dim + i - <span class="number">1</span>] = acc2;</span><br><span class="line">            dst[n + i] = acc3;</span><br><span class="line">        &#125;</span><br><span class="line">        j -= <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">for</span> (; j &lt; dim; j++)</span><br><span class="line">            dst[j * dim + i] = src[m + j];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-46"><a href="#6-46" class="headerlink" title="6.46"></a>6.46</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">col_convert</span><span class="params">(<span class="type">int</span>* G, <span class="type">int</span> dim)</span> &#123;</span><br><span class="line">    <span class="type">int</span> i, j, k, acc0, acc1, acc2, acc3;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; dim; i++) &#123;</span><br><span class="line">        k = i * dim;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">3</span>; j &lt; i; j += <span class="number">4</span>) &#123;</span><br><span class="line">            acc0 = G[k + j - <span class="number">3</span>];</span><br><span class="line">            acc1 = G[k + j - <span class="number">2</span>];</span><br><span class="line">            acc2 = G[k + j - <span class="number">1</span>];</span><br><span class="line">            acc3 = G[k + j];</span><br><span class="line">            G[(j - <span class="number">3</span>) * dim + i] |= acc0;</span><br><span class="line">            G[(j - <span class="number">2</span>) * dim + i] |= acc1;</span><br><span class="line">            G[(j - <span class="number">1</span>) * dim + i] |= acc2;</span><br><span class="line">            G[j * dim + i] |= acc3;</span><br><span class="line">        &#125;</span><br><span class="line">        j -= <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">for</span> (; j &lt; i; j++)</span><br><span class="line">            G[j * dim + i] |= G[k + j];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; dim; i++) &#123;</span><br><span class="line">        k = i * dim;</span><br><span class="line">        <span class="keyword">for</span> (j = i + <span class="number">4</span>; j &lt; dim; j += <span class="number">4</span>) &#123;</span><br><span class="line">			G[k + j - <span class="number">3</span>] = G[(j - <span class="number">3</span>) * dim + i];</span><br><span class="line">            G[k + j - <span class="number">2</span>] = G[(j - <span class="number">2</span>) * dim + i];</span><br><span class="line">            G[k + j - <span class="number">1</span>] = G[(j - <span class="number">1</span>) * dim + i];</span><br><span class="line">            G[k + j - <span class="number">0</span>] = G[(j - <span class="number">0</span>) * dim + i];</span><br><span class="line">        &#125;</span><br><span class="line">        j -= <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">for</span> (; j &lt; dim; j++)</span><br><span class="line">            G[k + j] = G[j * dim + i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Chapter7"><a href="#Chapter7" class="headerlink" title="Chapter7"></a>Chapter7</h1><h2 id="7-6"><a href="#7-6" class="headerlink" title="7.6"></a>7.6</h2><table>
<thead>
<tr>
<th align="center">符号</th>
<th align="center">.symtabl条目</th>
<th align="center">符号类型</th>
<th align="center">在哪个模块种定义</th>
<th align="center">节</th>
</tr>
</thead>
<tbody><tr>
<td align="center">buf</td>
<td align="center">是</td>
<td align="center">外部</td>
<td align="center">m.o</td>
<td align="center">.data</td>
</tr>
<tr>
<td align="center">bufp0</td>
<td align="center">是</td>
<td align="center">全局</td>
<td align="center">swap.o</td>
<td align="center">.data</td>
</tr>
<tr>
<td align="center">bufp1</td>
<td align="center">是</td>
<td align="center">局部</td>
<td align="center">swap.o</td>
<td align="center">.bss</td>
</tr>
<tr>
<td align="center">incr</td>
<td align="center">是</td>
<td align="center">局部</td>
<td align="center">swap.o</td>
<td align="center">.text</td>
</tr>
<tr>
<td align="center">count</td>
<td align="center">是</td>
<td align="center">局部</td>
<td align="center">swap.o</td>
<td align="center">.bss</td>
</tr>
<tr>
<td align="center">swap</td>
<td align="center">是</td>
<td align="center">全局</td>
<td align="center">swap.o</td>
<td align="center">.text</td>
</tr>
<tr>
<td align="center">temp</td>
<td align="center">否</td>
<td align="center">—-</td>
<td align="center">—-</td>
<td align="center">—-</td>
</tr>
</tbody></table>
<h2 id="7-7"><a href="#7-7" class="headerlink" title="7.7"></a>7.7</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* foo5.c */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">f</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> y = <span class="number">15212</span>;</span><br><span class="line"><span class="type">int</span> x = <span class="number">15213</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    f();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;x = 0x%x y = 0x%x \n&quot;</span>, x, y);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* bar5.c */</span></span><br><span class="line"><span class="type">double</span> x;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">f</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    x = <span class="number">996948845.0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-8"><a href="#7-8" class="headerlink" title="7.8"></a>7.8</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">A. a.REF(main.1)-&gt;DEF(main.1)</span><br><span class="line">   b.REF(main.2)-&gt;DEF(main.1)</span><br><span class="line"></span><br><span class="line">B. a.REF(x.1)-&gt;DEF(未知)</span><br><span class="line">   b.REF(x.2)-&gt;DEF(未知)</span><br><span class="line">   </span><br><span class="line">C. a.REF(x.1)-&gt;DEF(错误)</span><br><span class="line">   b.REF(x.2)-&gt;DEF(错误)</span><br></pre></td></tr></table></figure>

<h2 id="7-9"><a href="#7-9" class="headerlink" title="7.9"></a>7.9</h2><p>两个模块都定义有main,foo模块中的main是一个函数，为强符号；bar中的main是未定义的全局变量，为弱符号，链接器将选择foo模块中的main</p>
<h2 id="7-10"><a href="#7-10" class="headerlink" title="7.10"></a>7.10</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A.	gcc p.o libx.a</span><br><span class="line">B.	gcc p.o libx.a liby.a libx.a</span><br><span class="line">C.	gcc p.o libx.a liby.a libx.a libz.a</span><br></pre></td></tr></table></figure>

<h2 id="7-11"><a href="#7-11" class="headerlink" title="7.11"></a>7.11</h2><p>该段中剩下的8个字节对应于运行时将被初始化为0的.bss数据</p>
<h2 id="7-12"><a href="#7-12" class="headerlink" title="7.12"></a>7.12</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">A. ADDR(s) = ADDR(.text) = 0x4004e0</span><br><span class="line">   ADDR(r.symbol) = ADDR(swap) = 0x4004f8</span><br><span class="line">       refaddr = ADDR(s) + r.offset</span><br><span class="line">               = 0x4004e0 + 0xa</span><br><span class="line">               = 0x4004ea</span><br><span class="line">       *refptr = (unsigned) (ADDR(r.symbol) + r.addend - refaddr)</span><br><span class="line">               = (unsigned) (0x4004f8 - 0x4 - 0x0x4004ea)</span><br><span class="line">               = (unsigned) 0xa</span><br><span class="line"></span><br><span class="line">B. ADDR(s) = ADDR(.text) = 0x4004d0</span><br><span class="line">   ADDR(r.symbol) = ADDR(swap) = 0x400500</span><br><span class="line">       refaddr = ADDR(s) + r.offset</span><br><span class="line">               = 0x4004d0 + 0xa</span><br><span class="line">               = 0x4004da</span><br><span class="line">       *refptr = (unsigned) (ADDR(r.symbol) + r.addend - refaddr)</span><br><span class="line">               = (unsigned) (0x400500 - 0x4 - 0x0x4004da)</span><br><span class="line">               = (unsigned) 0x22 </span><br></pre></td></tr></table></figure>

<h1 id="Chapter8"><a href="#Chapter8" class="headerlink" title="Chapter8"></a>Chapter8</h1><h2 id="8-9"><a href="#8-9" class="headerlink" title="8.9"></a>8.9</h2><table>
<thead>
<tr>
<th align="center">进程对</th>
<th align="center">并发地？</th>
</tr>
</thead>
<tbody><tr>
<td align="center">AB</td>
<td align="center">否</td>
</tr>
<tr>
<td align="center">AC</td>
<td align="center">是</td>
</tr>
<tr>
<td align="center">AD</td>
<td align="center">是</td>
</tr>
<tr>
<td align="center">BC</td>
<td align="center">是</td>
</tr>
<tr>
<td align="center">BD</td>
<td align="center">是</td>
</tr>
<tr>
<td align="center">CD</td>
<td align="center">是</td>
</tr>
</tbody></table>
<h2 id="8-10"><a href="#8-10" class="headerlink" title="8.10"></a>8.10</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A. fork</span><br><span class="line">B. execve, longjmp</span><br><span class="line">C. setjmp</span><br></pre></td></tr></table></figure>

<h2 id="8-11"><a href="#8-11" class="headerlink" title="8.11"></a>8.11</h2><p>4个</p>
<h2 id="8-12"><a href="#8-12" class="headerlink" title="8.12"></a>8.12</h2><p>8个</p>
<h2 id="8-13"><a href="#8-13" class="headerlink" title="8.13"></a>8.13</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x=2</span><br><span class="line">x=4</span><br><span class="line">x=3</span><br></pre></td></tr></table></figure>

<h2 id="8-14"><a href="#8-14" class="headerlink" title="8.14"></a>8.14</h2><p>3个</p>
<h2 id="8-15"><a href="#8-15" class="headerlink" title="8.15"></a>8.15</h2><p>5个</p>
<h2 id="8-16"><a href="#8-16" class="headerlink" title="8.16"></a>8.16</h2><p>2</p>
<h2 id="8-17"><a href="#8-17" class="headerlink" title="8.17"></a>8.17</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">case 1:</span><br><span class="line">Hello</span><br><span class="line">1</span><br><span class="line">Bye</span><br><span class="line">0</span><br><span class="line">2</span><br><span class="line">Bye</span><br><span class="line"></span><br><span class="line">case 2:</span><br><span class="line">Hello</span><br><span class="line">1</span><br><span class="line">0</span><br><span class="line">Bye</span><br><span class="line">2</span><br><span class="line">Bye</span><br><span class="line"></span><br><span class="line">case 3:</span><br><span class="line">Hello</span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">Bye</span><br><span class="line">2</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>

<h2 id="8-18"><a href="#8-18" class="headerlink" title="8.18"></a>8.18</h2><p>可能的输出：A,C,E</p>
<h2 id="8-19"><a href="#8-19" class="headerlink" title="8.19"></a>8.19</h2><p>2的n次方</p>
<h2 id="8-20"><a href="#8-20" class="headerlink" title="8.20"></a>8.20</h2><p>我所使用的是shell程序为bash而非csh，因此</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">linux&gt; setenv COLUMNS 40</span><br><span class="line">linux&gt; unsetenv COLUMNS</span><br></pre></td></tr></table></figure>

<p>应改为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">linux&gt; export COLUMNS=40</span><br><span class="line">linux&gt; unset COLUMNS</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argvp[], <span class="type">char</span>* envp[])</span> &#123;</span><br><span class="line">    <span class="type">char</span>* p = getenv(<span class="string">&quot;COLUMNS&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>)</span><br><span class="line">        setenv(<span class="string">&quot;COLUMNS&quot;</span>, <span class="string">&quot;80&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    execve(<span class="string">&quot;/bin/ls&quot;</span>, argv, envp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际上我写这个并没能实现按COLUMNS的值不同而显示不同的功能，但暂时不知道怎么改，先就这样</p>
<h2 id="8-21"><a href="#8-21" class="headerlink" title="8.21"></a>8.21</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">abc</span><br><span class="line">bac</span><br></pre></td></tr></table></figure>

<h2 id="8-22"><a href="#8-22" class="headerlink" title="8.22"></a>8.22</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">mysystem</span><span class="params">(<span class="type">char</span>* command)</span> &#123;</span><br><span class="line">        <span class="type">pid_t</span> pid;</span><br><span class="line">        <span class="type">int</span> status;</span><br><span class="line">        <span class="keyword">if</span> (pid = fork() == <span class="number">0</span>) &#123;</span><br><span class="line">                execl(<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, command, (<span class="type">char</span>*)<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(waitpid(pid, &amp;status, WUNTRACED) == pid) &#123;</span><br><span class="line">                <span class="keyword">if</span> (WIFEXITED(status)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> WEXITSTATUS(status);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (WIFSIGNALED(status)) &#123;</span><br><span class="line">                        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;command terminated by signal number %d.\n&quot;</span>, WTERMSIG(status));</span><br><span class="line">                        <span class="keyword">return</span> WTERMSIG(status);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-23"><a href="#8-23" class="headerlink" title="8.23"></a>8.23</h2><p>未经处理的信号是不排队的。在子进程发送第一个SIGUSR2信号号给父进程时，count++，在sleep(1)时，后续四个信号均已发出，而父进程的pending位向量只会保留一个SIGUSR2信号，因此即使发送了5个信号，count值也为2</p>
<h2 id="8-24"><a href="#8-24" class="headerlink" title="8.24"></a>8.24</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;csapp.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N 2</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> status, i;</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Parent creates N children */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line">        <span class="keyword">if</span> ((pid = Fork()) == <span class="number">0</span>) <span class="comment">/* Child */</span></span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">100</span> + i);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Parent reaps N children in no particular order */</span></span><br><span class="line">    <span class="keyword">while</span> ((pid = waitpid(<span class="number">-1</span>, &amp;status, <span class="number">0</span>) &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (WIFEXITED(status))</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;child %d terminated normally with exit status=%d\n&quot;</span>, pid, WEXITSTATUS(status));</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (WIFSIGNALED(status)) &#123;</span><br><span class="line">            <span class="type">char</span>* sigErr = strsignal(WTERMSIG(status))</span><br><span class="line">            psignal(WTERMSIG(status), sigErr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-25"><a href="#8-25" class="headerlink" title="8.25"></a>8.25</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;csapp.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sigalrm_handler</span><span class="params">(<span class="type">int</span> sig)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (alarm(<span class="number">0</span>) == <span class="number">0</span>)</span><br><span class="line">                _exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span>* <span class="title function_">tfgets</span><span class="params">(<span class="type">char</span>* str, <span class="type">int</span> n, FILE* stream)</span> &#123;</span><br><span class="line">        signal(SIGALRM, sigalrm_handler);</span><br><span class="line">        alarm(<span class="number">5</span>);</span><br><span class="line">        fgets(str, n, stream);</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-26"><a href="#8-26" class="headerlink" title="8.26"></a>8.26</h2><p>不做，完成Shell Lab代替之</p>
<h2 id="Chapter9"><a href="#Chapter9" class="headerlink" title="Chapter9"></a>Chapter9</h2><h2 id="9-11"><a href="#9-11" class="headerlink" title="9.11"></a>9.11</h2><p>虚拟地址格式</p>
<table>
<thead>
<tr>
<th align="center">13</th>
<th align="center">12</th>
<th align="center">11</th>
<th align="center">10</th>
<th align="center">9</th>
<th align="center">8</th>
<th align="center">7</th>
<th align="center">6</th>
<th align="center">5</th>
<th align="center">4</th>
<th align="center">3</th>
<th align="center">2</th>
<th align="center">1</th>
<th align="center">0</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
</tr>
</tbody></table>
<p>地址翻译</p>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">VPN</td>
<td align="center">0x9</td>
</tr>
<tr>
<td align="center">TLB索引</td>
<td align="center">0x1</td>
</tr>
<tr>
<td align="center">TLB标记</td>
<td align="center">0x2</td>
</tr>
<tr>
<td align="center">TLB命中？</td>
<td align="center">是</td>
</tr>
<tr>
<td align="center">缺页？</td>
<td align="center">是</td>
</tr>
<tr>
<td align="center">PPN</td>
<td align="center">—-</td>
</tr>
</tbody></table>
<h2 id="9-12"><a href="#9-12" class="headerlink" title="9.12"></a>9.12</h2><p>虚拟地址格式</p>
<table>
<thead>
<tr>
<th align="center">13</th>
<th align="center">12</th>
<th align="center">11</th>
<th align="center">10</th>
<th align="center">9</th>
<th align="center">8</th>
<th align="center">7</th>
<th align="center">6</th>
<th align="center">5</th>
<th align="center">4</th>
<th align="center">3</th>
<th align="center">2</th>
<th align="center">1</th>
<th align="center">0</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
</tr>
</tbody></table>
<p>地址翻译</p>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">VPN</td>
<td align="center">0x0E</td>
</tr>
<tr>
<td align="center">TLB索引</td>
<td align="center">0x2</td>
</tr>
<tr>
<td align="center">TLB标记</td>
<td align="center">0x3</td>
</tr>
<tr>
<td align="center">TLB命中?</td>
<td align="center">是</td>
</tr>
<tr>
<td align="center">缺页?</td>
<td align="center">是</td>
</tr>
<tr>
<td align="center">PPN</td>
<td align="center">—-</td>
</tr>
</tbody></table>
<h2 id="9-13"><a href="#9-13" class="headerlink" title="9.13"></a>9.13</h2><p>虚拟地址格式</p>
<table>
<thead>
<tr>
<th align="center">13</th>
<th align="center">12</th>
<th align="center">11</th>
<th align="center">10</th>
<th align="center">9</th>
<th align="center">8</th>
<th align="center">7</th>
<th align="center">6</th>
<th align="center">5</th>
<th align="center">4</th>
<th align="center">3</th>
<th align="center">2</th>
<th align="center">1</th>
<th align="center">0</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
</tr>
</tbody></table>
<p>地址翻译</p>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">VPN</td>
<td align="center">0x1</td>
</tr>
<tr>
<td align="center">TLB索引</td>
<td align="center">0x1</td>
</tr>
<tr>
<td align="center">TLB标记</td>
<td align="center">0x0</td>
</tr>
<tr>
<td align="center">TLB命中?</td>
<td align="center">否</td>
</tr>
<tr>
<td align="center">缺页?</td>
<td align="center">是</td>
</tr>
<tr>
<td align="center">PPN</td>
<td align="center">—-</td>
</tr>
</tbody></table>
<h2 id="9-14"><a href="#9-14" class="headerlink" title="9.14"></a>9.14</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* problem914.c */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;csapp.h&quot;</span></span></span><br><span class="line">  </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">stat</span>;</span></span><br><span class="line">        <span class="type">int</span> fd;</span><br><span class="line">        <span class="type">char</span>* bufp;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Copy the input argument */</span></span><br><span class="line">        fd = Open(argv[<span class="number">1</span>], O_RDONLY, <span class="number">0</span>);</span><br><span class="line">        fstat(fd, &amp;stat);</span><br><span class="line">        bufp = Mmap(<span class="literal">NULL</span>, stat.st_size, PROT_WRITE | PROT_READ, MAP_PRIVATE, fd, <span class="number">0</span>);</span><br><span class="line">        bufp[<span class="number">0</span>] = <span class="string">&#x27;J&#x27;</span>;</span><br><span class="line">        write(<span class="number">1</span>, bufp, stat.st_size);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fez@papyruszzz:~/Sketch$ cat hello.txt </span><br><span class="line">Hello, world!</span><br><span class="line">fez@papyruszzz:~/Sketch$ gcc -o prog mmapcopy.c csapp.h csapp.c -lpthread</span><br><span class="line">fez@papyruszzz:~/Sketch$ ./prog hello.txt </span><br><span class="line">Jello, world!</span><br></pre></td></tr></table></figure>

<h2 id="9-15"><a href="#9-15" class="headerlink" title="9.15"></a>9.15</h2><table>
<thead>
<tr>
<th align="center">请求</th>
<th align="center">块大小（十进制字节）</th>
<th align="center">块头部（十六进制）</th>
</tr>
</thead>
<tbody><tr>
<td align="center">malloc(3)</td>
<td align="center">8</td>
<td align="center">0x9</td>
</tr>
<tr>
<td align="center">malloc(11)</td>
<td align="center">16</td>
<td align="center">0x11</td>
</tr>
<tr>
<td align="center">malloc(20)</td>
<td align="center">24</td>
<td align="center">0x19</td>
</tr>
<tr>
<td align="center">malloc(21)</td>
<td align="center">32</td>
<td align="center">0x21</td>
</tr>
</tbody></table>
<h2 id="9-16"><a href="#9-16" class="headerlink" title="9.16"></a>9.16</h2><table>
<thead>
<tr>
<th align="center">对齐要求</th>
<th align="center">已分配块</th>
<th align="center">空闲块</th>
<th align="center">最小块大小（字节）</th>
</tr>
</thead>
<tbody><tr>
<td align="center">单字</td>
<td align="center">头部和脚部</td>
<td align="center">头部和脚部</td>
<td align="center">16</td>
</tr>
<tr>
<td align="center">单字</td>
<td align="center">头部，但是没有脚部</td>
<td align="center">头部和脚部</td>
<td align="center">16</td>
</tr>
<tr>
<td align="center">双字</td>
<td align="center">头部和脚部</td>
<td align="center">头部和脚部</td>
<td align="center">16</td>
</tr>
<tr>
<td align="center">双字</td>
<td align="center">头部，但是没有脚部</td>
<td align="center">头部和脚部</td>
<td align="center">16</td>
</tr>
</tbody></table>
<h2 id="9-17"><a href="#9-17" class="headerlink" title="9.17"></a>9.17</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * Simple, 32-bit and 64-bit clean allocator based on implicit free</span></span><br><span class="line"><span class="comment"> * lists, first-fit placement, and boundary tag coalescing, as described</span></span><br><span class="line"><span class="comment"> * in the CS:APP3e text. Blocks must be aligned to doubleword (8 byte) </span></span><br><span class="line"><span class="comment"> * boundaries. Minimum block size is 16 bytes. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;mm.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;memlib.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If NEXT_FIT defined use next fit search, else use first-fit search </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NEXT_FITx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* $begin mallocmacros */</span></span><br><span class="line"><span class="comment">/* Basic constants and macros */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WSIZE       4       <span class="comment">/* Word and header/footer size (bytes) */</span> <span class="comment">//line:vm:mm:beginconst</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DSIZE       8       <span class="comment">/* Double word size (bytes) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHUNKSIZE  (1&lt;&lt;12)  <span class="comment">/* Extend heap by this amount (bytes) */</span>  <span class="comment">//line:vm:mm:endconst </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX(x, y) ((x) &gt; (y)? (x) : (y))  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Pack a size and allocated bit into a word */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PACK(size, alloc)  ((size) | (alloc)) <span class="comment">//line:vm:mm:pack</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Read and write a word at address p */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET(p)       (*(unsigned int *)(p))            <span class="comment">//line:vm:mm:get</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUT(p, val)  (*(unsigned int *)(p) = (val))    <span class="comment">//line:vm:mm:put</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Read the size and allocated fields from address p */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_SIZE(p)  (GET(p) &amp; ~0x7)                   <span class="comment">//line:vm:mm:getsize</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_ALLOC(p) (GET(p) &amp; 0x1)                    <span class="comment">//line:vm:mm:getalloc</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Given block ptr bp, compute address of its header and footer */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HDRP(bp)       ((char *)(bp) - WSIZE)                      <span class="comment">//line:vm:mm:hdrp</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FTRP(bp)       ((char *)(bp) + GET_SIZE(HDRP(bp)) - DSIZE) <span class="comment">//line:vm:mm:ftrp</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Given block ptr bp, compute address of next and previous blocks */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NEXT_BLKP(bp)  ((char *)(bp) + GET_SIZE(((char *)(bp) - WSIZE))) <span class="comment">//line:vm:mm:nextblkp</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREV_BLKP(bp)  ((char *)(bp) - GET_SIZE(((char *)(bp) - DSIZE))) <span class="comment">//line:vm:mm:prevblkp</span></span></span><br><span class="line"><span class="comment">/* $end mallocmacros */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Global variables */</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *heap_listp = <span class="number">0</span>;  <span class="comment">/* Pointer to first block */</span>  </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> NEXT_FIT</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *rover;           <span class="comment">/* Next fit rover */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Function prototypes for internal helper routines */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">extend_heap</span><span class="params">(<span class="type">size_t</span> words)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">place</span><span class="params">(<span class="type">void</span> *bp, <span class="type">size_t</span> asize)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">find_fit</span><span class="params">(<span class="type">size_t</span> asize)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">coalesce</span><span class="params">(<span class="type">void</span> *bp)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">printblock</span><span class="params">(<span class="type">void</span> *bp)</span>; </span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">checkheap</span><span class="params">(<span class="type">int</span> verbose)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">checkblock</span><span class="params">(<span class="type">void</span> *bp)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * mm_init - Initialize the memory manager </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* $begin mminit */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">mm_init</span><span class="params">(<span class="type">void</span>)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* Create the initial empty heap */</span></span><br><span class="line">    <span class="keyword">if</span> ((heap_listp = mem_sbrk(<span class="number">4</span>*WSIZE)) == (<span class="type">void</span> *)<span class="number">-1</span>) <span class="comment">//line:vm:mm:begininit</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    PUT(heap_listp, <span class="number">0</span>);                          <span class="comment">/* Alignment padding */</span></span><br><span class="line">    PUT(heap_listp + (<span class="number">1</span>*WSIZE), PACK(DSIZE, <span class="number">1</span>)); <span class="comment">/* Prologue header */</span> </span><br><span class="line">    PUT(heap_listp + (<span class="number">2</span>*WSIZE), PACK(DSIZE, <span class="number">1</span>)); <span class="comment">/* Prologue footer */</span> </span><br><span class="line">    PUT(heap_listp + (<span class="number">3</span>*WSIZE), PACK(<span class="number">0</span>, <span class="number">1</span>));     <span class="comment">/* Epilogue header */</span></span><br><span class="line">    heap_listp += (<span class="number">2</span>*WSIZE);                     <span class="comment">//line:vm:mm:endinit  </span></span><br><span class="line">    <span class="comment">/* $end mminit */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> NEXT_FIT</span></span><br><span class="line">    rover = heap_listp;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* $begin mminit */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Extend the empty heap with a free block of CHUNKSIZE bytes */</span></span><br><span class="line">    <span class="keyword">if</span> (extend_heap(CHUNKSIZE/WSIZE) == <span class="literal">NULL</span>) </span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end mminit */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * mm_malloc - Allocate a block with at least size bytes of payload </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* $begin mmmalloc */</span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">mm_malloc</span><span class="params">(<span class="type">size_t</span> size)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> asize;      <span class="comment">/* Adjusted block size */</span></span><br><span class="line">    <span class="type">size_t</span> extendsize; <span class="comment">/* Amount to extend heap if no fit */</span></span><br><span class="line">    <span class="type">char</span> *bp;      </span><br><span class="line"></span><br><span class="line">    <span class="comment">/* $end mmmalloc */</span></span><br><span class="line">    <span class="keyword">if</span> (heap_listp == <span class="number">0</span>)&#123;</span><br><span class="line">        mm_init();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* $begin mmmalloc */</span></span><br><span class="line">    <span class="comment">/* Ignore spurious requests */</span></span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Adjust block size to include overhead and alignment reqs. */</span></span><br><span class="line">    <span class="keyword">if</span> (size &lt;= DSIZE)                                          <span class="comment">//line:vm:mm:sizeadjust1</span></span><br><span class="line">        asize = <span class="number">2</span>*DSIZE;                                        <span class="comment">//line:vm:mm:sizeadjust2</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        asize = DSIZE * ((size + (DSIZE) + (DSIZE<span class="number">-1</span>)) / DSIZE); <span class="comment">//line:vm:mm:sizeadjust3</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Search the free list for a fit */</span></span><br><span class="line">    <span class="keyword">if</span> ((bp = find_fit(asize)) != <span class="literal">NULL</span>) &#123;  <span class="comment">//line:vm:mm:findfitcall</span></span><br><span class="line">        place(bp, asize);                  <span class="comment">//line:vm:mm:findfitplace</span></span><br><span class="line">        <span class="keyword">return</span> bp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* No fit found. Get more memory and place the block */</span></span><br><span class="line">    extendsize = MAX(asize,CHUNKSIZE);                 <span class="comment">//line:vm:mm:growheap1</span></span><br><span class="line">    <span class="keyword">if</span> ((bp = extend_heap(extendsize/WSIZE)) == <span class="literal">NULL</span>)  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;                                  <span class="comment">//line:vm:mm:growheap2</span></span><br><span class="line">    place(bp, asize);                                 <span class="comment">//line:vm:mm:growheap3</span></span><br><span class="line">    <span class="keyword">return</span> bp;</span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">/* $end mmmalloc */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * mm_free - Free a block </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* $begin mmfree */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">mm_free</span><span class="params">(<span class="type">void</span> *bp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* $end mmfree */</span></span><br><span class="line">    <span class="keyword">if</span> (bp == <span class="number">0</span>) </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* $begin mmfree */</span></span><br><span class="line">    <span class="type">size_t</span> size = GET_SIZE(HDRP(bp));</span><br><span class="line">    <span class="comment">/* $end mmfree */</span></span><br><span class="line">    <span class="keyword">if</span> (heap_listp == <span class="number">0</span>)&#123;</span><br><span class="line">        mm_init();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* $begin mmfree */</span></span><br><span class="line"></span><br><span class="line">    PUT(HDRP(bp), PACK(size, <span class="number">0</span>));</span><br><span class="line">    PUT(FTRP(bp), PACK(size, <span class="number">0</span>));</span><br><span class="line">    coalesce(bp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* $end mmfree */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * coalesce - Boundary tag coalescing. Return ptr to coalesced block</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* $begin mmfree */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">coalesce</span><span class="params">(<span class="type">void</span> *bp)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> prev_alloc = GET_ALLOC(FTRP(PREV_BLKP(bp)));</span><br><span class="line">    <span class="type">size_t</span> next_alloc = GET_ALLOC(HDRP(NEXT_BLKP(bp)));</span><br><span class="line">    <span class="type">size_t</span> size = GET_SIZE(HDRP(bp));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prev_alloc &amp;&amp; next_alloc) &#123;            <span class="comment">/* Case 1 */</span></span><br><span class="line">        <span class="keyword">return</span> bp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (prev_alloc &amp;&amp; !next_alloc) &#123;      <span class="comment">/* Case 2 */</span></span><br><span class="line">        size += GET_SIZE(HDRP(NEXT_BLKP(bp)));</span><br><span class="line">        PUT(HDRP(bp), PACK(size, <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(size,<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!prev_alloc &amp;&amp; next_alloc) &#123;      <span class="comment">/* Case 3 */</span></span><br><span class="line">        size += GET_SIZE(HDRP(PREV_BLKP(bp)));</span><br><span class="line">        PUT(FTRP(bp), PACK(size, <span class="number">0</span>));</span><br><span class="line">        PUT(HDRP(PREV_BLKP(bp)), PACK(size, <span class="number">0</span>));</span><br><span class="line">        bp = PREV_BLKP(bp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> &#123;                                     <span class="comment">/* Case 4 */</span></span><br><span class="line">        size += GET_SIZE(HDRP(PREV_BLKP(bp))) + </span><br><span class="line">            GET_SIZE(FTRP(NEXT_BLKP(bp)));</span><br><span class="line">        PUT(HDRP(PREV_BLKP(bp)), PACK(size, <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(NEXT_BLKP(bp)), PACK(size, <span class="number">0</span>));</span><br><span class="line">        bp = PREV_BLKP(bp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* $end mmfree */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> NEXT_FIT</span></span><br><span class="line">    <span class="comment">/* Make sure the rover isn&#x27;t pointing into the free block */</span></span><br><span class="line">    <span class="comment">/* that we just coalesced */</span></span><br><span class="line">    <span class="keyword">if</span> ((rover &gt; (<span class="type">char</span> *)bp) &amp;&amp; (rover &lt; NEXT_BLKP(bp))) </span><br><span class="line">        rover = bp;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* $begin mmfree */</span></span><br><span class="line">    <span class="keyword">return</span> bp;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end mmfree */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * mm_realloc - Naive implementation of realloc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">mm_realloc</span><span class="params">(<span class="type">void</span> *ptr, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> oldsize;</span><br><span class="line">    <span class="type">void</span> *newptr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If size == 0 then this is just free, and we return NULL. */</span></span><br><span class="line">    <span class="keyword">if</span>(size == <span class="number">0</span>) &#123;</span><br><span class="line">        mm_free(ptr);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If oldptr is NULL, then this is just malloc. */</span></span><br><span class="line">    <span class="keyword">if</span>(ptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mm_malloc(size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    newptr = mm_malloc(size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If realloc() fails the original block is left untouched  */</span></span><br><span class="line">    <span class="keyword">if</span>(!newptr) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Copy the old data. */</span></span><br><span class="line">    oldsize = GET_SIZE(HDRP(ptr));</span><br><span class="line">    <span class="keyword">if</span>(size &lt; oldsize) oldsize = size;</span><br><span class="line">    <span class="built_in">memcpy</span>(newptr, ptr, oldsize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Free the old block. */</span></span><br><span class="line">    mm_free(ptr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> newptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * mm_checkheap - Check the heap for correctness</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">mm_checkheap</span><span class="params">(<span class="type">int</span> verbose)</span>  </span><br><span class="line">&#123; </span><br><span class="line">    checkheap(verbose);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * The remaining routines are internal helper routines </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * extend_heap - Extend heap with free block and return its block pointer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* $begin mmextendheap */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">extend_heap</span><span class="params">(<span class="type">size_t</span> words)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *bp;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Allocate an even number of words to maintain alignment */</span></span><br><span class="line">    size = (words % <span class="number">2</span>) ? (words+<span class="number">1</span>) * WSIZE : words * WSIZE; <span class="comment">//line:vm:mm:beginextend</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">long</span>)(bp = mem_sbrk(size)) == <span class="number">-1</span>)  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;                                        <span class="comment">//line:vm:mm:endextend</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize free block header/footer and the epilogue header */</span></span><br><span class="line">    PUT(HDRP(bp), PACK(size, <span class="number">0</span>));         <span class="comment">/* Free block header */</span>   <span class="comment">//line:vm:mm:freeblockhdr</span></span><br><span class="line">    PUT(FTRP(bp), PACK(size, <span class="number">0</span>));         <span class="comment">/* Free block footer */</span>   <span class="comment">//line:vm:mm:freeblockftr</span></span><br><span class="line">    PUT(HDRP(NEXT_BLKP(bp)), PACK(<span class="number">0</span>, <span class="number">1</span>)); <span class="comment">/* New epilogue header */</span> <span class="comment">//line:vm:mm:newepihdr</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Coalesce if the previous block was free */</span></span><br><span class="line">    <span class="keyword">return</span> coalesce(bp);                                          <span class="comment">//line:vm:mm:returnblock</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end mmextendheap */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * place - Place block of asize bytes at start of free block bp </span></span><br><span class="line"><span class="comment"> *         and split if remainder would be at least minimum block size</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* $begin mmplace */</span></span><br><span class="line"><span class="comment">/* $begin mmplace-proto */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">place</span><span class="params">(<span class="type">void</span> *bp, <span class="type">size_t</span> asize)</span></span><br><span class="line"><span class="comment">/* $end mmplace-proto */</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> csize = GET_SIZE(HDRP(bp));   </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((csize - asize) &gt;= (<span class="number">2</span>*DSIZE)) &#123; </span><br><span class="line">        PUT(HDRP(bp), PACK(asize, <span class="number">1</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(asize, <span class="number">1</span>));</span><br><span class="line">        bp = NEXT_BLKP(bp);</span><br><span class="line">        PUT(HDRP(bp), PACK(csize-asize, <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(csize-asize, <span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">        PUT(HDRP(bp), PACK(csize, <span class="number">1</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(csize, <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end mmplace */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * find_fit - Find a fit for a block with asize bytes </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* $begin mmfirstfit */</span></span><br><span class="line"><span class="comment">/* $begin mmfirstfit-proto */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">find_fit</span><span class="params">(<span class="type">size_t</span> asize)</span></span><br><span class="line"><span class="comment">/* $end mmfirstfit-proto */</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* $end mmfirstfit */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> NEXT_FIT </span></span><br><span class="line">    <span class="comment">/* Next fit search */</span></span><br><span class="line">    <span class="type">char</span> *oldrover = rover;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Search from the rover to the end of list */</span></span><br><span class="line">    <span class="keyword">for</span> ( ; GET_SIZE(HDRP(rover)) &gt; <span class="number">0</span>; rover = NEXT_BLKP(rover))</span><br><span class="line">        <span class="keyword">if</span> (!GET_ALLOC(HDRP(rover)) &amp;&amp; (asize &lt;= GET_SIZE(HDRP(rover))))</span><br><span class="line">            <span class="keyword">return</span> rover;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* search from start of list to old rover */</span></span><br><span class="line">    <span class="keyword">for</span> (rover = heap_listp; rover &lt; oldrover; rover = NEXT_BLKP(rover))</span><br><span class="line">        <span class="keyword">if</span> (!GET_ALLOC(HDRP(rover)) &amp;&amp; (asize &lt;= GET_SIZE(HDRP(rover))))</span><br><span class="line">            <span class="keyword">return</span> rover;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;  <span class="comment">/* no fit found */</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span> </span></span><br><span class="line">    <span class="comment">/* $begin mmfirstfit */</span></span><br><span class="line">    <span class="comment">/* First-fit search */</span></span><br><span class="line">    <span class="type">void</span> *bp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (bp = heap_listp; GET_SIZE(HDRP(bp)) &gt; <span class="number">0</span>; bp = NEXT_BLKP(bp)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!GET_ALLOC(HDRP(bp)) &amp;&amp; (asize &lt;= GET_SIZE(HDRP(bp)))) &#123;</span><br><span class="line">            <span class="keyword">return</span> bp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>; <span class="comment">/* No fit */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end mmfirstfit */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">printblock</span><span class="params">(<span class="type">void</span> *bp)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> hsize, halloc, fsize, falloc;</span><br><span class="line"></span><br><span class="line">    checkheap(<span class="number">0</span>);</span><br><span class="line">    hsize = GET_SIZE(HDRP(bp));</span><br><span class="line">    halloc = GET_ALLOC(HDRP(bp));  </span><br><span class="line">    fsize = GET_SIZE(FTRP(bp));</span><br><span class="line">    falloc = GET_ALLOC(FTRP(bp));  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hsize == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%p: EOL\n&quot;</span>, bp);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p: header: [%ld:%c] footer: [%ld:%c]\n&quot;</span>, bp, </span><br><span class="line">           hsize, (halloc ? <span class="string">&#x27;a&#x27;</span> : <span class="string">&#x27;f&#x27;</span>), </span><br><span class="line">           fsize, (falloc ? <span class="string">&#x27;a&#x27;</span> : <span class="string">&#x27;f&#x27;</span>)); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">checkblock</span><span class="params">(<span class="type">void</span> *bp)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">size_t</span>)bp % <span class="number">8</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error: %p is not doubleword aligned\n&quot;</span>, bp);</span><br><span class="line">    <span class="keyword">if</span> (GET(HDRP(bp)) != GET(FTRP(bp)))</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error: header does not match footer\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * checkheap - Minimal check of the heap for consistency </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">checkheap</span><span class="params">(<span class="type">int</span> verbose)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *bp = heap_listp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (verbose)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Heap (%p):\n&quot;</span>, heap_listp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((GET_SIZE(HDRP(heap_listp)) != DSIZE) || !GET_ALLOC(HDRP(heap_listp)))</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Bad prologue header\n&quot;</span>);</span><br><span class="line">    checkblock(heap_listp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (bp = heap_listp; GET_SIZE(HDRP(bp)) &gt; <span class="number">0</span>; bp = NEXT_BLKP(bp)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (verbose) </span><br><span class="line">            printblock(bp);</span><br><span class="line">        checkblock(bp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (verbose)</span><br><span class="line">        printblock(bp);</span><br><span class="line">    <span class="keyword">if</span> ((GET_SIZE(HDRP(bp)) != <span class="number">0</span>) || !(GET_ALLOC(HDRP(bp))))</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Bad epilogue header\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="9-18"><a href="#9-18" class="headerlink" title="9.18"></a>9.18</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * Simple, 32-bit and 64-bit clean allocator based on implicit free</span></span><br><span class="line"><span class="comment"> * lists, first-fit placement, and boundary tag coalescing, as described</span></span><br><span class="line"><span class="comment"> * in the CS:APP3e text. Blocks must be aligned to doubleword (8 byte) </span></span><br><span class="line"><span class="comment"> * boundaries. Minimum block size is 16 bytes. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;mm.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;memlib.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If NEXT_FIT defined use next fit search, else use first-fit search </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NEXT_FITx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* $begin mallocmacros */</span></span><br><span class="line"><span class="comment">/* Basic constants and macros */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WSIZE       4       <span class="comment">/* Word and header/footer size (bytes) */</span> <span class="comment">//line:vm:mm:beginconst</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DSIZE       8       <span class="comment">/* Double word size (bytes) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHUNKSIZE  (1&lt;&lt;12)  <span class="comment">/* Extend heap by this amount (bytes) */</span>  <span class="comment">//line:vm:mm:endconst </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX(x, y) ((x) &gt; (y)? (x) : (y))  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Pack a size and allocated bit into a word */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PACK(size, alloc)  ((size) | (alloc)) <span class="comment">//line:vm:mm:pack</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Read and write a word at address p */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET(p)       (*(unsigned int *)(p))            <span class="comment">//line:vm:mm:get</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUT(p, val)  (*(unsigned int *)(p) = (val))    <span class="comment">//line:vm:mm:put</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Read the size and allocated fields from address p */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_SIZE(p)  (GET(p) &amp; ~0x7)                   <span class="comment">//line:vm:mm:getsize</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_ALLOC(p) (GET(p) &amp; 0x1)                    <span class="comment">//line:vm:mm:getalloc</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Given block ptr bp, compute address of its header and footer */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HDRP(bp)       ((char *)(bp) - WSIZE)                      <span class="comment">//line:vm:mm:hdrp</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FTRP(bp)       ((char *)(bp) + GET_SIZE(HDRP(bp)) - DSIZE) <span class="comment">//line:vm:mm:ftrp</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Given block ptr bp, compute address of next and previous blocks */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NEXT_BLKP(bp)  ((char *)(bp) + GET_SIZE(((char *)(bp) - WSIZE))) <span class="comment">//line:vm:mm:nextblkp</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREV_BLKP(bp)  ((char *)(bp) - GET_SIZE(((char *)(bp) - DSIZE))) <span class="comment">//line:vm:mm:prevblkp</span></span></span><br><span class="line"><span class="comment">/* $end mallocmacros */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Global variables */</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *heap_listp = <span class="number">0</span>;  <span class="comment">/* Pointer to first block */</span>  </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> NEXT_FIT</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *rover;           <span class="comment">/* Next fit rover */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Function prototypes for internal helper routines */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">extend_heap</span><span class="params">(<span class="type">size_t</span> words)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">place</span><span class="params">(<span class="type">void</span> *bp, <span class="type">size_t</span> asize)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">find_fit</span><span class="params">(<span class="type">size_t</span> asize)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">coalesce</span><span class="params">(<span class="type">void</span> *bp)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">printblock</span><span class="params">(<span class="type">void</span> *bp)</span>; </span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">checkheap</span><span class="params">(<span class="type">int</span> verbose)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">checkblock</span><span class="params">(<span class="type">void</span> *bp)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * mm_init - Initialize the memory manager </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* $begin mminit */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">mm_init</span><span class="params">(<span class="type">void</span>)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* Create the initial empty heap */</span></span><br><span class="line">    <span class="keyword">if</span> ((heap_listp = mem_sbrk(<span class="number">4</span>*WSIZE)) == (<span class="type">void</span> *)<span class="number">-1</span>) <span class="comment">//line:vm:mm:begininit</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    PUT(heap_listp, <span class="number">0</span>);                          <span class="comment">/* Alignment padding */</span></span><br><span class="line">    PUT(heap_listp + (<span class="number">1</span>*WSIZE), PACK(DSIZE, <span class="number">1</span>)); <span class="comment">/* Prologue header */</span> </span><br><span class="line">    PUT(heap_listp + (<span class="number">2</span>*WSIZE), PACK(DSIZE, <span class="number">1</span>)); <span class="comment">/* Alignment padding */</span> </span><br><span class="line">    PUT(heap_listp + (<span class="number">3</span>*WSIZE), PACK(<span class="number">0</span>, <span class="number">1</span>));     <span class="comment">/* Epilogue header */</span></span><br><span class="line">    heap_listp += (<span class="number">2</span>*WSIZE);                     <span class="comment">//line:vm:mm:endinit  </span></span><br><span class="line">    <span class="comment">/* $end mminit */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> NEXT_FIT</span></span><br><span class="line">    rover = heap_listp;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* $begin mminit */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Extend the empty heap with a free block of CHUNKSIZE bytes */</span></span><br><span class="line">    <span class="keyword">if</span> (extend_heap(CHUNKSIZE/WSIZE) == <span class="literal">NULL</span>) </span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end mminit */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * mm_malloc - Allocate a block with at least size bytes of payload </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* $begin mmmalloc */</span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">mm_malloc</span><span class="params">(<span class="type">size_t</span> size)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> asize;      <span class="comment">/* Adjusted block size */</span></span><br><span class="line">    <span class="type">size_t</span> extendsize; <span class="comment">/* Amount to extend heap if no fit */</span></span><br><span class="line">    <span class="type">char</span> *bp;      </span><br><span class="line"></span><br><span class="line">    <span class="comment">/* $end mmmalloc */</span></span><br><span class="line">    <span class="keyword">if</span> (heap_listp == <span class="number">0</span>)&#123;</span><br><span class="line">        mm_init();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* $begin mmmalloc */</span></span><br><span class="line">    <span class="comment">/* Ignore spurious requests */</span></span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Adjust block size to include overhead and alignment reqs. */</span></span><br><span class="line">    <span class="keyword">if</span> (size &lt;= DSIZE)                                          <span class="comment">//line:vm:mm:sizeadjust1</span></span><br><span class="line">        asize = <span class="number">2</span>*DSIZE;                                        <span class="comment">//line:vm:mm:sizeadjust2</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        asize = DSIZE * ((size + (WSIZE) + (DSIZE<span class="number">-1</span>)) / DSIZE); <span class="comment">//line:vm:mm:sizeadjust3</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Search the free list for a fit */</span></span><br><span class="line">    <span class="keyword">if</span> ((bp = find_fit(asize)) != <span class="literal">NULL</span>) &#123;  <span class="comment">//line:vm:mm:findfitcall</span></span><br><span class="line">        place(bp, asize);                  <span class="comment">//line:vm:mm:findfitplace</span></span><br><span class="line">        <span class="keyword">return</span> bp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* No fit found. Get more memory and place the block */</span></span><br><span class="line">    extendsize = MAX(asize,CHUNKSIZE);                 <span class="comment">//line:vm:mm:growheap1</span></span><br><span class="line">    <span class="keyword">if</span> ((bp = extend_heap(extendsize/WSIZE)) == <span class="literal">NULL</span>)  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;                                  <span class="comment">//line:vm:mm:growheap2</span></span><br><span class="line">    place(bp, asize);                                 <span class="comment">//line:vm:mm:growheap3</span></span><br><span class="line">    <span class="keyword">return</span> bp;</span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">/* $end mmmalloc */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * mm_free - Free a block </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* $begin mmfree */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">mm_free</span><span class="params">(<span class="type">void</span> *bp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* $end mmfree */</span></span><br><span class="line">    <span class="keyword">if</span> (bp == <span class="number">0</span>) </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* $begin mmfree */</span></span><br><span class="line">    <span class="type">size_t</span> size = GET_SIZE(HDRP(bp));</span><br><span class="line">    <span class="comment">/* $end mmfree */</span></span><br><span class="line">    <span class="keyword">if</span> (heap_listp == <span class="number">0</span>)&#123;</span><br><span class="line">        mm_init();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* $begin mmfree */</span></span><br><span class="line"></span><br><span class="line">    PUT(HDRP(bp), PACK(size, <span class="number">0</span>));</span><br><span class="line">    PUT(FTRP(bp), PACK(size, <span class="number">0</span>));</span><br><span class="line">    coalesce(bp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* $end mmfree */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * coalesce - Boundary tag coalescing. Return ptr to coalesced block</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* $begin mmfree */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">coalesce</span><span class="params">(<span class="type">void</span> *bp)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> prev_alloc = GET_ALLOC(HDRP(PREV_BLKP(bp)));</span><br><span class="line">    <span class="type">size_t</span> next_alloc = GET_ALLOC(HDRP(NEXT_BLKP(bp)));</span><br><span class="line">    <span class="type">size_t</span> size = GET_SIZE(HDRP(bp));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prev_alloc &amp;&amp; next_alloc) &#123;            <span class="comment">/* Case 1 */</span></span><br><span class="line">        <span class="keyword">return</span> bp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (prev_alloc &amp;&amp; !next_alloc) &#123;      <span class="comment">/* Case 2 */</span></span><br><span class="line">        size += GET_SIZE(HDRP(NEXT_BLKP(bp)));</span><br><span class="line">        PUT(HDRP(bp), PACK(size, <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(size,<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!prev_alloc &amp;&amp; next_alloc) &#123;      <span class="comment">/* Case 3 */</span></span><br><span class="line">        size += GET_SIZE(HDRP(PREV_BLKP(bp)));</span><br><span class="line">        PUT(FTRP(bp), PACK(size, <span class="number">0</span>));</span><br><span class="line">        PUT(HDRP(PREV_BLKP(bp)), PACK(size, <span class="number">0</span>));</span><br><span class="line">        bp = PREV_BLKP(bp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> &#123;                                     <span class="comment">/* Case 4 */</span></span><br><span class="line">        size += GET_SIZE(HDRP(PREV_BLKP(bp))) + </span><br><span class="line">            GET_SIZE(FTRP(NEXT_BLKP(bp)));</span><br><span class="line">        PUT(HDRP(PREV_BLKP(bp)), PACK(size, <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(NEXT_BLKP(bp)), PACK(size, <span class="number">0</span>));</span><br><span class="line">        bp = PREV_BLKP(bp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* $end mmfree */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> NEXT_FIT</span></span><br><span class="line">    <span class="comment">/* Make sure the rover isn&#x27;t pointing into the free block */</span></span><br><span class="line">    <span class="comment">/* that we just coalesced */</span></span><br><span class="line">    <span class="keyword">if</span> ((rover &gt; (<span class="type">char</span> *)bp) &amp;&amp; (rover &lt; NEXT_BLKP(bp))) </span><br><span class="line">        rover = bp;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* $begin mmfree */</span></span><br><span class="line">    <span class="keyword">return</span> bp;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end mmfree */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * mm_realloc - Naive implementation of realloc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">mm_realloc</span><span class="params">(<span class="type">void</span> *ptr, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> oldsize;</span><br><span class="line">    <span class="type">void</span> *newptr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If size == 0 then this is just free, and we return NULL. */</span></span><br><span class="line">    <span class="keyword">if</span>(size == <span class="number">0</span>) &#123;</span><br><span class="line">        mm_free(ptr);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If oldptr is NULL, then this is just malloc. */</span></span><br><span class="line">    <span class="keyword">if</span>(ptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mm_malloc(size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    newptr = mm_malloc(size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If realloc() fails the original block is left untouched  */</span></span><br><span class="line">    <span class="keyword">if</span>(!newptr) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Copy the old data. */</span></span><br><span class="line">    oldsize = GET_SIZE(HDRP(ptr));</span><br><span class="line">    <span class="keyword">if</span>(size &lt; oldsize) oldsize = size;</span><br><span class="line">    <span class="built_in">memcpy</span>(newptr, ptr, oldsize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Free the old block. */</span></span><br><span class="line">    mm_free(ptr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> newptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * mm_checkheap - Check the heap for correctness</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">mm_checkheap</span><span class="params">(<span class="type">int</span> verbose)</span>  </span><br><span class="line">&#123; </span><br><span class="line">    checkheap(verbose);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * The remaining routines are internal helper routines </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * extend_heap - Extend heap with free block and return its block pointer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* $begin mmextendheap */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">extend_heap</span><span class="params">(<span class="type">size_t</span> words)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *bp;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Allocate an even number of words to maintain alignment */</span></span><br><span class="line">    size = (words % <span class="number">2</span>) ? (words+<span class="number">1</span>) * WSIZE : words * WSIZE; <span class="comment">//line:vm:mm:beginextend</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">long</span>)(bp = mem_sbrk(size)) == <span class="number">-1</span>)  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;                                        <span class="comment">//line:vm:mm:endextend</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize free block header/footer and the epilogue header */</span></span><br><span class="line">    PUT(HDRP(bp), PACK(size, <span class="number">0</span>));         <span class="comment">/* Free block header */</span>   <span class="comment">//line:vm:mm:freeblockhdr</span></span><br><span class="line">    PUT(FTRP(bp), PACK(size, <span class="number">0</span>));         <span class="comment">/* Free block footer */</span>   <span class="comment">//line:vm:mm:freeblockftr</span></span><br><span class="line">    PUT(HDRP(NEXT_BLKP(bp)), PACK(<span class="number">0</span>, <span class="number">1</span>)); <span class="comment">/* New epilogue header */</span> <span class="comment">//line:vm:mm:newepihdr</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Coalesce if the previous block was free */</span></span><br><span class="line">    <span class="keyword">return</span> coalesce(bp);                                          <span class="comment">//line:vm:mm:returnblock</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end mmextendheap */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * place - Place block of asize bytes at start of free block bp </span></span><br><span class="line"><span class="comment"> *         and split if remainder would be at least minimum block size</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* $begin mmplace */</span></span><br><span class="line"><span class="comment">/* $begin mmplace-proto */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">place</span><span class="params">(<span class="type">void</span> *bp, <span class="type">size_t</span> asize)</span></span><br><span class="line"><span class="comment">/* $end mmplace-proto */</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> csize = GET_SIZE(HDRP(bp));   </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((csize - asize) &gt;= (<span class="number">2</span>*DSIZE)) &#123; </span><br><span class="line">        PUT(HDRP(bp), PACK(asize, <span class="number">1</span>));</span><br><span class="line">        bp = NEXT_BLKP(bp);</span><br><span class="line">        PUT(HDRP(bp), PACK(csize-asize, <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(csize-asize, <span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">        PUT(HDRP(bp), PACK(csize, <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end mmplace */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * find_fit - Find a fit for a block with asize bytes </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* $begin mmfirstfit */</span></span><br><span class="line"><span class="comment">/* $begin mmfirstfit-proto */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">find_fit</span><span class="params">(<span class="type">size_t</span> asize)</span></span><br><span class="line"><span class="comment">/* $end mmfirstfit-proto */</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* $end mmfirstfit */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> NEXT_FIT </span></span><br><span class="line">    <span class="comment">/* Next fit search */</span></span><br><span class="line">    <span class="type">char</span> *oldrover = rover;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Search from the rover to the end of list */</span></span><br><span class="line">    <span class="keyword">for</span> ( ; GET_SIZE(HDRP(rover)) &gt; <span class="number">0</span>; rover = NEXT_BLKP(rover))</span><br><span class="line">        <span class="keyword">if</span> (!GET_ALLOC(HDRP(rover)) &amp;&amp; (asize &lt;= GET_SIZE(HDRP(rover))))</span><br><span class="line">            <span class="keyword">return</span> rover;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* search from start of list to old rover */</span></span><br><span class="line">    <span class="keyword">for</span> (rover = heap_listp; rover &lt; oldrover; rover = NEXT_BLKP(rover))</span><br><span class="line">        <span class="keyword">if</span> (!GET_ALLOC(HDRP(rover)) &amp;&amp; (asize &lt;= GET_SIZE(HDRP(rover))))</span><br><span class="line">            <span class="keyword">return</span> rover;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;  <span class="comment">/* no fit found */</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span> </span></span><br><span class="line">    <span class="comment">/* $begin mmfirstfit */</span></span><br><span class="line">    <span class="comment">/* First-fit search */</span></span><br><span class="line">    <span class="type">void</span> *bp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (bp = heap_listp; GET_SIZE(HDRP(bp)) &gt; <span class="number">0</span>; bp = NEXT_BLKP(bp)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!GET_ALLOC(HDRP(bp)) &amp;&amp; (asize &lt;= GET_SIZE(HDRP(bp)))) &#123;</span><br><span class="line">            <span class="keyword">return</span> bp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>; <span class="comment">/* No fit */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end mmfirstfit */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">printblock</span><span class="params">(<span class="type">void</span> *bp)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> hsize, halloc, fsize, falloc;</span><br><span class="line"></span><br><span class="line">    checkheap(<span class="number">0</span>);</span><br><span class="line">    hsize = GET_SIZE(HDRP(bp));</span><br><span class="line">    halloc = GET_ALLOC(HDRP(bp));  </span><br><span class="line">    fsize = GET_SIZE(FTRP(bp));</span><br><span class="line">    falloc = GET_ALLOC(FTRP(bp));  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hsize == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%p: EOL\n&quot;</span>, bp);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p: header: [%ld:%c] footer: [%ld:%c]\n&quot;</span>, bp, </span><br><span class="line">           hsize, (halloc ? <span class="string">&#x27;a&#x27;</span> : <span class="string">&#x27;f&#x27;</span>), </span><br><span class="line">           fsize, (falloc ? <span class="string">&#x27;a&#x27;</span> : <span class="string">&#x27;f&#x27;</span>)); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">checkblock</span><span class="params">(<span class="type">void</span> *bp)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">size_t</span>)bp % <span class="number">8</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error: %p is not doubleword aligned\n&quot;</span>, bp);</span><br><span class="line">    <span class="keyword">if</span> (GET(HDRP(bp)) != GET(FTRP(bp)))</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error: header does not match footer\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * checkheap - Minimal check of the heap for consistency </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">checkheap</span><span class="params">(<span class="type">int</span> verbose)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *bp = heap_listp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (verbose)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Heap (%p):\n&quot;</span>, heap_listp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((GET_SIZE(HDRP(heap_listp)) != DSIZE) || !GET_ALLOC(HDRP(heap_listp)))</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Bad prologue header\n&quot;</span>);</span><br><span class="line">    checkblock(heap_listp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (bp = heap_listp; GET_SIZE(HDRP(bp)) &gt; <span class="number">0</span>; bp = NEXT_BLKP(bp)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (verbose) </span><br><span class="line">            printblock(bp);</span><br><span class="line">        checkblock(bp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (verbose)</span><br><span class="line">        printblock(bp);</span><br><span class="line">    <span class="keyword">if</span> ((GET_SIZE(HDRP(bp)) != <span class="number">0</span>) || !(GET_ALLOC(HDRP(bp))))</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Bad epilogue header\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="9-19"><a href="#9-19" class="headerlink" title="9.19"></a>9.19</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1) c</span><br><span class="line">2) d</span><br><span class="line">3) b</span><br></pre></td></tr></table></figure>

<h2 id="9-20"><a href="#9-20" class="headerlink" title="9.20"></a>9.20</h2><p>不做，完成Malloc Lab代替之</p>
<h1 id="Chapter10"><a href="#Chapter10" class="headerlink" title="Chapter10"></a>Chapter10</h1><h2 id="10-6"><a href="#10-6" class="headerlink" title="10.6"></a>10.6</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fd2 = 4</span><br></pre></td></tr></table></figure>

<h2 id="10-7"><a href="#10-7" class="headerlink" title="10.7"></a>10.7</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;csapp.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXBUF 128</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">	<span class="type">int</span> n;</span><br><span class="line">	<span class="type">rio_t</span> rio;</span><br><span class="line">	<span class="type">char</span> buf[MAXLINE];</span><br><span class="line">	</span><br><span class="line">	Rio_readinitb(&amp;rio, STDIN_FILENO);</span><br><span class="line">	<span class="keyword">while</span>((n = Rio_readlineb(&amp;rio, buf, MAXLINE)) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (n != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">int</span> fit_size = n &gt; MAXBUF? MAXBUF : n;</span><br><span class="line">            Rio_writen(STDOUT_FILENO, buf, fit_size);</span><br><span class="line">            n -= fit_size;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="10-8"><a href="#10-8" class="headerlink" title="10.8"></a>10.8</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;csapp.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">stat</span>;</span></span><br><span class="line">    <span class="type">char</span> *type, *readok;</span><br><span class="line">    <span class="type">int</span> fd = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">    </span><br><span class="line">    fstat(fd, &amp;stat);</span><br><span class="line">    <span class="keyword">if</span> (S_ISREG(stat.st_mode))</span><br><span class="line">        type = <span class="string">&quot;regular&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (S_ISDIR(stat.st_mode))</span><br><span class="line">        type = <span class="string">&quot;directory&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        type = <span class="string">&quot;other&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> ((stat.st_mode &amp; S_IRUSR))</span><br><span class="line">        readok = <span class="string">&quot;yes&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        readok = <span class="string">&quot;no&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;type: %s, read: %s\n&quot;</span>, type, readok);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="10-9"><a href="#10-9" class="headerlink" title="10.9"></a>10.9</h2><p>不会</p>
<p>看了别人的题解还是不理解</p>
<h2 id="10-10"><a href="#10-10" class="headerlink" title="10.10"></a>10.10</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;csapp.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line">    <span class="type">rio_t</span> rio;</span><br><span class="line">    <span class="type">char</span> buf[MAXLINE];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">2</span>) <span class="comment">/* infile */</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> fd = Open(argv[<span class="number">1</span>], O_RDONLY|O_CREAT);</span><br><span class="line">        Dup2(fd, STDIN_FILENO);</span><br><span class="line">        Close(fd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (argc &gt; <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage: %s [--infile]\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Rio_readinitb(&amp;rio, STDIN_FILENO);</span><br><span class="line">    <span class="keyword">while</span>((n = Rio_readlineb(&amp;rio, buf, MAXLINE)) != <span class="number">0</span>) </span><br><span class="line">	    Rio_writen(STDOUT_FILENO, buf, n);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Chapter12"><a href="#Chapter12" class="headerlink" title="Chapter12"></a>Chapter12</h1><h2 id="12-16"><a href="#12-16" class="headerlink" title="12.16"></a>12.16</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;csapp.h&quot;</span></span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">thread</span><span class="params">(<span class="type">void</span> *vargp)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> num, i;</span><br><span class="line">    <span class="type">pthread_t</span> *tid;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;usage: %s &lt;num&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    num = atoi(agrv[<span class="number">1</span>]);</span><br><span class="line">    tid = Calloc(num, <span class="keyword">sizeof</span>(<span class="type">pthread_t</span>));</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">        Pthread_create(&amp;tid[i], <span class="literal">NULL</span>, thread, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">        Pthread_join(tid, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">thread</span><span class="params">(<span class="type">void</span> *vargp)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello, world!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="12-17"><a href="#12-17" class="headerlink" title="12.17"></a>12.17</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A. 该线程睡眠时，主线程调用exit()函数，所有线程均强制结束，也就没来得及输出</span><br><span class="line">B. Pthread_join()</span><br></pre></td></tr></table></figure>

<h2 id="12-18"><a href="#12-18" class="headerlink" title="12.18"></a>12.18</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A. unsafe</span><br><span class="line">B. safe</span><br><span class="line">C. unsafe</span><br></pre></td></tr></table></figure>

<h2 id="12-19"><a href="#12-19" class="headerlink" title="12.19"></a>12.19</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> readcnt;					<span class="comment">/* Initially = 0 */</span></span><br><span class="line"><span class="type">sem_t</span> mutex, w, reader_first; 	<span class="comment">/* All initially = 1 */</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">reader</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        P(&amp;mutex);</span><br><span class="line">        readcnt++;</span><br><span class="line">        <span class="keyword">if</span> (readcnt == <span class="number">1</span>) &#123;</span><br><span class="line">            P(&amp;w);</span><br><span class="line">        &#125;</span><br><span class="line">        V(&amp;mutex);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* Critical section */</span></span><br><span class="line">        <span class="comment">/* Reading happens  */</span></span><br><span class="line">        </span><br><span class="line">        P(&amp;mutex);</span><br><span class="line">        readcnt--;</span><br><span class="line">        <span class="keyword">if</span> (readcnt == <span class="number">0</span>)</span><br><span class="line">            V(&amp;w);</span><br><span class="line">        V(&amp;mutex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">writer</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        P(&amp;reader_first);</span><br><span class="line">        P(&amp;w);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* Critical section */</span></span><br><span class="line">        <span class="comment">/* writing happens  */</span></span><br><span class="line">        </span><br><span class="line">        V(&amp;w);</span><br><span class="line">        P(&amp;mutex);</span><br><span class="line">        V(&amp;reader_first);</span><br><span class="line">        V(&amp;mutex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="12-20"><a href="#12-20" class="headerlink" title="12.20"></a>12.20</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">sem_t</span> mutex, w, readable; 		<span class="comment">/* mutex, w initially = 1, readable initally n */</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">reader</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        P(&amp;readable);</span><br><span class="line">        P(&amp;mutex);</span><br><span class="line">        P(&amp;w);</span><br><span class="line">        V(&amp;mutex);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* Critical section */</span></span><br><span class="line">        <span class="comment">/* Reading happens  */</span></span><br><span class="line">        </span><br><span class="line">        P(&amp;mutex);</span><br><span class="line">        V(&amp;w);</span><br><span class="line">        V(&amp;mutex);</span><br><span class="line">        V(&amp;readable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">writer</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        P(&amp;w);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* Critical section */</span></span><br><span class="line">        <span class="comment">/* writing happens  */</span></span><br><span class="line">        </span><br><span class="line">        V(&amp;w);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="12-21"><a href="#12-21" class="headerlink" title="12.21"></a>12.21</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> writecnt, readcnt;			<span class="comment">/* Both initially = 0 */</span></span><br><span class="line"><span class="type">sem_t</span> wmutex, rmutex, w, read; 		<span class="comment">/* All initially = 1  */</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">reader</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        P(&amp;read);</span><br><span class="line">        P(&amp;rmutex);</span><br><span class="line">        readcnt++;</span><br><span class="line">        <span class="keyword">if</span> (readcnt == <span class="number">1</span>)</span><br><span class="line">            P(&amp;w);</span><br><span class="line">        V(&amp;rmutex);</span><br><span class="line">        V(&amp;read);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* Critical section */</span></span><br><span class="line">        <span class="comment">/* Reading happens  */</span></span><br><span class="line">        </span><br><span class="line">        P(&amp;rmutex);</span><br><span class="line">        readcnt--;</span><br><span class="line">        <span class="keyword">if</span> (readcnt == <span class="number">0</span>)</span><br><span class="line">        	V(&amp;w);</span><br><span class="line">        V(&amp;mutex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">writer</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        P(&amp;wmutex);</span><br><span class="line">        writecnt++;</span><br><span class="line">        <span class="keyword">if</span> (writecnt == <span class="number">1</span>) </span><br><span class="line">            P(&amp;read);</span><br><span class="line">        V(&amp;wmutex);</span><br><span class="line">        </span><br><span class="line">        P(&amp;w);</span><br><span class="line">        <span class="comment">/* Critical section */</span></span><br><span class="line">        <span class="comment">/* writing happens  */</span></span><br><span class="line">        V(&amp;w);</span><br><span class="line">        </span><br><span class="line">        P(&amp;wmutex);</span><br><span class="line">        writecnt--;</span><br><span class="line">        <span class="keyword">if</span> (writecnt == <span class="number">0</span>)</span><br><span class="line">            V(&amp;read);</span><br><span class="line">        V(&amp;w);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">做着百万梦的鱼</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/09/23/CSAPP/">http://example.com/2024/09/23/CSAPP/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">梦下随笔</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CSAPP/">CSAPP</a></div><div class="post_share"><div class="social-share" data-image="/./picture/person.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/./picture/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/./picture/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/./picture/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/./picture/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2024/09/18/Data-Structure-Ch-2/" title="Data Structure Ch-2"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Data Structure Ch-2</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/./picture/person.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">做着百万梦的鱼</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">4</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/unbridled-41"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/unbridled-41" target="_blank" title="Github"><i class="fab fa-github" style="color: #hdhfbb;"></i></a><a class="social-icon" href="/2896626324@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #000000;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">持续更新中。。。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter2"><span class="toc-number">1.</span> <span class="toc-text">Chapter2</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-55"><span class="toc-number">1.1.</span> <span class="toc-text">2.55</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-57"><span class="toc-number">1.2.</span> <span class="toc-text">2.57</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-58"><span class="toc-number">1.3.</span> <span class="toc-text">2.58</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-59"><span class="toc-number">1.4.</span> <span class="toc-text">2.59</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-60"><span class="toc-number">1.5.</span> <span class="toc-text">2.60</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-61"><span class="toc-number">1.6.</span> <span class="toc-text">2.61</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-62"><span class="toc-number">1.7.</span> <span class="toc-text">2.62</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-63"><span class="toc-number">1.8.</span> <span class="toc-text">2.63</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-64"><span class="toc-number">1.9.</span> <span class="toc-text">2.64</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-65"><span class="toc-number">1.10.</span> <span class="toc-text">2.65</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-66"><span class="toc-number">1.11.</span> <span class="toc-text">2.66</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-67"><span class="toc-number">1.12.</span> <span class="toc-text">2.67</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-68"><span class="toc-number">1.13.</span> <span class="toc-text">2.68</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-69"><span class="toc-number">1.14.</span> <span class="toc-text">2.69</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-70"><span class="toc-number">1.15.</span> <span class="toc-text">2.70</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-71"><span class="toc-number">1.16.</span> <span class="toc-text">2.71</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-72"><span class="toc-number">1.17.</span> <span class="toc-text">2.72</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-73"><span class="toc-number">1.18.</span> <span class="toc-text">2.73</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-74"><span class="toc-number">1.19.</span> <span class="toc-text">2.74</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-75"><span class="toc-number">1.20.</span> <span class="toc-text">2.75</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-76"><span class="toc-number">1.21.</span> <span class="toc-text">2.76</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-77"><span class="toc-number">1.22.</span> <span class="toc-text">2.77</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-78"><span class="toc-number">1.23.</span> <span class="toc-text">2.78</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-79"><span class="toc-number">1.24.</span> <span class="toc-text">2.79</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-80"><span class="toc-number">1.25.</span> <span class="toc-text">2.80</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-81"><span class="toc-number">1.26.</span> <span class="toc-text">2.81</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-82"><span class="toc-number">1.27.</span> <span class="toc-text">2.82</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-83"><span class="toc-number">1.28.</span> <span class="toc-text">2.83</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-84"><span class="toc-number">1.29.</span> <span class="toc-text">2.84</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-85"><span class="toc-number">1.30.</span> <span class="toc-text">2.85</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-90"><span class="toc-number">1.31.</span> <span class="toc-text">2.90</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-92"><span class="toc-number">1.32.</span> <span class="toc-text">2.92</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-93"><span class="toc-number">1.33.</span> <span class="toc-text">2.93</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-94"><span class="toc-number">1.34.</span> <span class="toc-text">2.94</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-95"><span class="toc-number">1.35.</span> <span class="toc-text">2.95</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-96"><span class="toc-number">1.36.</span> <span class="toc-text">2.96</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-97"><span class="toc-number">1.37.</span> <span class="toc-text">2.97</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter3"><span class="toc-number">2.</span> <span class="toc-text">Chapter3</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-58"><span class="toc-number">2.1.</span> <span class="toc-text">3.58</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-59"><span class="toc-number">2.2.</span> <span class="toc-text">3.59</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-60"><span class="toc-number">2.3.</span> <span class="toc-text">3.60</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-61"><span class="toc-number">2.4.</span> <span class="toc-text">3.61</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-62"><span class="toc-number">2.5.</span> <span class="toc-text">3.62</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-63"><span class="toc-number">2.6.</span> <span class="toc-text">3.63</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-64"><span class="toc-number">2.7.</span> <span class="toc-text">3.64</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-65"><span class="toc-number">2.8.</span> <span class="toc-text">3.65</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-66"><span class="toc-number">2.9.</span> <span class="toc-text">3.66</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-67"><span class="toc-number">2.10.</span> <span class="toc-text">3.67</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-68"><span class="toc-number">2.11.</span> <span class="toc-text">3.68</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-69"><span class="toc-number">2.12.</span> <span class="toc-text">3.69</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-70"><span class="toc-number">2.13.</span> <span class="toc-text">3.70</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-71"><span class="toc-number">2.14.</span> <span class="toc-text">3.71</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-72"><span class="toc-number">2.15.</span> <span class="toc-text">3.72</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-73"><span class="toc-number">2.16.</span> <span class="toc-text">3.73</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-74"><span class="toc-number">2.17.</span> <span class="toc-text">3.74</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-75"><span class="toc-number">2.18.</span> <span class="toc-text">3.75</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter4"><span class="toc-number">3.</span> <span class="toc-text">Chapter4</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-45"><span class="toc-number">3.1.</span> <span class="toc-text">4.45</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-46"><span class="toc-number">3.2.</span> <span class="toc-text">4.46</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-47"><span class="toc-number">3.3.</span> <span class="toc-text">4.47</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-48"><span class="toc-number">3.4.</span> <span class="toc-text">4.48</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-49"><span class="toc-number">3.5.</span> <span class="toc-text">4.49</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-50"><span class="toc-number">3.6.</span> <span class="toc-text">4.50</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-51"><span class="toc-number">3.7.</span> <span class="toc-text">4.51</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-53"><span class="toc-number">3.8.</span> <span class="toc-text">4.53</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-57"><span class="toc-number">3.9.</span> <span class="toc-text">4.57</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-58"><span class="toc-number">3.10.</span> <span class="toc-text">4.58</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-59"><span class="toc-number">3.11.</span> <span class="toc-text">4.59</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter5"><span class="toc-number">4.</span> <span class="toc-text">Chapter5</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-14"><span class="toc-number">4.1.</span> <span class="toc-text">5.14</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-15"><span class="toc-number">4.2.</span> <span class="toc-text">5.15</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-16"><span class="toc-number">4.3.</span> <span class="toc-text">5.16</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-17"><span class="toc-number">4.4.</span> <span class="toc-text">5.17</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-18"><span class="toc-number">4.5.</span> <span class="toc-text">5.18</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-19"><span class="toc-number">4.6.</span> <span class="toc-text">5.19</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter6"><span class="toc-number">5.</span> <span class="toc-text">Chapter6</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-22"><span class="toc-number">5.1.</span> <span class="toc-text">6.22</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-23"><span class="toc-number">5.2.</span> <span class="toc-text">6.23</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-24"><span class="toc-number">5.3.</span> <span class="toc-text">6.24</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-25"><span class="toc-number">5.4.</span> <span class="toc-text">6.25</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-26"><span class="toc-number">5.5.</span> <span class="toc-text">6.26</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-27"><span class="toc-number">5.6.</span> <span class="toc-text">6.27</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-28"><span class="toc-number">5.7.</span> <span class="toc-text">6.28</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-29"><span class="toc-number">5.8.</span> <span class="toc-text">6.29</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-30"><span class="toc-number">5.9.</span> <span class="toc-text">6.30</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-31"><span class="toc-number">5.10.</span> <span class="toc-text">6.31</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-32"><span class="toc-number">5.11.</span> <span class="toc-text">6.32</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-33"><span class="toc-number">5.12.</span> <span class="toc-text">6.33</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-34"><span class="toc-number">5.13.</span> <span class="toc-text">6.34</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-35"><span class="toc-number">5.14.</span> <span class="toc-text">6.35</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-36"><span class="toc-number">5.15.</span> <span class="toc-text">6.36</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-37"><span class="toc-number">5.16.</span> <span class="toc-text">6.37</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-38"><span class="toc-number">5.17.</span> <span class="toc-text">6.38</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-39"><span class="toc-number">5.18.</span> <span class="toc-text">6.39</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-40"><span class="toc-number">5.19.</span> <span class="toc-text">6.40</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-41"><span class="toc-number">5.20.</span> <span class="toc-text">6.41</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-42"><span class="toc-number">5.21.</span> <span class="toc-text">6.42</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-43"><span class="toc-number">5.22.</span> <span class="toc-text">6.43</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-44"><span class="toc-number">5.23.</span> <span class="toc-text">6.44</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-45"><span class="toc-number">5.24.</span> <span class="toc-text">6.45</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-46"><span class="toc-number">5.25.</span> <span class="toc-text">6.46</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter7"><span class="toc-number">6.</span> <span class="toc-text">Chapter7</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-6"><span class="toc-number">6.1.</span> <span class="toc-text">7.6</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-7"><span class="toc-number">6.2.</span> <span class="toc-text">7.7</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-8"><span class="toc-number">6.3.</span> <span class="toc-text">7.8</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-9"><span class="toc-number">6.4.</span> <span class="toc-text">7.9</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-10"><span class="toc-number">6.5.</span> <span class="toc-text">7.10</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-11"><span class="toc-number">6.6.</span> <span class="toc-text">7.11</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-12"><span class="toc-number">6.7.</span> <span class="toc-text">7.12</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter8"><span class="toc-number">7.</span> <span class="toc-text">Chapter8</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-9"><span class="toc-number">7.1.</span> <span class="toc-text">8.9</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-10"><span class="toc-number">7.2.</span> <span class="toc-text">8.10</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-11"><span class="toc-number">7.3.</span> <span class="toc-text">8.11</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-12"><span class="toc-number">7.4.</span> <span class="toc-text">8.12</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-13"><span class="toc-number">7.5.</span> <span class="toc-text">8.13</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-14"><span class="toc-number">7.6.</span> <span class="toc-text">8.14</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-15"><span class="toc-number">7.7.</span> <span class="toc-text">8.15</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-16"><span class="toc-number">7.8.</span> <span class="toc-text">8.16</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-17"><span class="toc-number">7.9.</span> <span class="toc-text">8.17</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-18"><span class="toc-number">7.10.</span> <span class="toc-text">8.18</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-19"><span class="toc-number">7.11.</span> <span class="toc-text">8.19</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-20"><span class="toc-number">7.12.</span> <span class="toc-text">8.20</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-21"><span class="toc-number">7.13.</span> <span class="toc-text">8.21</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-22"><span class="toc-number">7.14.</span> <span class="toc-text">8.22</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-23"><span class="toc-number">7.15.</span> <span class="toc-text">8.23</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-24"><span class="toc-number">7.16.</span> <span class="toc-text">8.24</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-25"><span class="toc-number">7.17.</span> <span class="toc-text">8.25</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-26"><span class="toc-number">7.18.</span> <span class="toc-text">8.26</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chapter9"><span class="toc-number">7.19.</span> <span class="toc-text">Chapter9</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-11"><span class="toc-number">7.20.</span> <span class="toc-text">9.11</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-12"><span class="toc-number">7.21.</span> <span class="toc-text">9.12</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-13"><span class="toc-number">7.22.</span> <span class="toc-text">9.13</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-14"><span class="toc-number">7.23.</span> <span class="toc-text">9.14</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-15"><span class="toc-number">7.24.</span> <span class="toc-text">9.15</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-16"><span class="toc-number">7.25.</span> <span class="toc-text">9.16</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-17"><span class="toc-number">7.26.</span> <span class="toc-text">9.17</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-18"><span class="toc-number">7.27.</span> <span class="toc-text">9.18</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-19"><span class="toc-number">7.28.</span> <span class="toc-text">9.19</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-20"><span class="toc-number">7.29.</span> <span class="toc-text">9.20</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter10"><span class="toc-number">8.</span> <span class="toc-text">Chapter10</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-6"><span class="toc-number">8.1.</span> <span class="toc-text">10.6</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-7"><span class="toc-number">8.2.</span> <span class="toc-text">10.7</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-8"><span class="toc-number">8.3.</span> <span class="toc-text">10.8</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-9"><span class="toc-number">8.4.</span> <span class="toc-text">10.9</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-10"><span class="toc-number">8.5.</span> <span class="toc-text">10.10</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter12"><span class="toc-number">9.</span> <span class="toc-text">Chapter12</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#12-16"><span class="toc-number">9.1.</span> <span class="toc-text">12.16</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-17"><span class="toc-number">9.2.</span> <span class="toc-text">12.17</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-18"><span class="toc-number">9.3.</span> <span class="toc-text">12.18</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-19"><span class="toc-number">9.4.</span> <span class="toc-text">12.19</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-20"><span class="toc-number">9.5.</span> <span class="toc-text">12.20</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-21"><span class="toc-number">9.6.</span> <span class="toc-text">12.21</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/23/CSAPP/" title="CSAPP">CSAPP</a><time datetime="2024-09-23T01:08:28.000Z" title="发表于 2024-09-23 09:08:28">2024-09-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/18/Data-Structure-Ch-2/" title="Data Structure Ch-2">Data Structure Ch-2</a><time datetime="2024-09-18T14:31:59.000Z" title="发表于 2024-09-18 22:31:59">2024-09-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/16/Data-Structure-Ch-1/" title="Data Structure Ch.1">Data Structure Ch.1</a><time datetime="2024-09-16T14:48:06.000Z" title="发表于 2024-09-16 22:48:06">2024-09-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/16/hello-world/" title="Hello World">Hello World</a><time datetime="2024-09-16T14:10:29.000Z" title="发表于 2024-09-16 22:10:29">2024-09-16</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By 做着百万梦的鱼</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>